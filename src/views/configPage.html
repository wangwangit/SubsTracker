
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»ç»Ÿé…ç½® - è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  ${themeResources} <style>
    
    .toast {
      position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
      color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
      transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background-color: #10b981; }
    .toast.error { background-color: #ef4444; }
    .toast.info { background-color: #3b82f6; }
    .toast.warning { background-color: #f59e0b; }
    html.dark .toast {
      color: #f9fafb;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
    }
    html.dark .toast.success { background-color: #059669; }
    html.dark .toast.error { background-color: #dc2626; }
    html.dark .toast.info { background-color: #2563eb; }
    html.dark .toast.warning { background-color: #d97706; }
    
    .config-section { 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      padding: 16px; 
      margin-bottom: 24px; 
    }
    .config-section.active { 
      background-color: #f8fafc; 
      border-color: #6366f1; 
    }
    .config-section.inactive { 
      background-color: #f9fafb; 
      opacity: 0.7; 
    }
    /* === Config Page æš—é»‘æ¨¡å¼ä¿®å¤ === */
    html.dark .config-section {
      border-color: #374151;
    }
    html.dark .config-section.active {
      background-color: rgba(31, 41, 55, 0.5); /* #1f2937 with opacity */
      border-color: #818cf8;
    }
    html.dark .config-section.inactive {
      background-color: #111827;
      opacity: 0.5;
    }
    html.dark .bg-indigo-50 {
        background-color: rgba(55, 65, 81, 0.5) !important; /* æ·±ç°è‰²å¸¦é€æ˜ */
        border-color: #4b5563 !important;
    }
    html.dark .text-indigo-700 {
        color: #a5b4fc !important; /* æµ…é›è“ */
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="toast-container"></div>

  <nav class="bg-white shadow-md relative z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center shrink-0">
          <div class="flex items-center">
            <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
          </div>
          <span id="systemTimeDisplay" class="ml-4 text-base text-indigo-600 font-normal hidden md:block pt-1"></span>
        </div>
          
        <div class="hidden md:flex items-center space-x-4 ml-auto">
          <a href="/admin/dashboard" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-chart-line mr-1"></i>ä»ªè¡¨ç›˜
          </a>
          <a href="/admin" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
          </a>
          <a href="/admin/config" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
          </a>
          <a href="/api/logout" class="text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
          </a>
        </div>

        <div class="flex items-center md:hidden ml-auto">
          <button id="mobile-menu-btn" type="button" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•" class="text-gray-600 hover:text-indigo-600 focus:outline-none p-2 rounded-md hover:bg-gray-100 active:bg-gray-200 transition-colors">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-b border-gray-200 w-full">
      <div class="px-4 pt-2 pb-4 space-y-2">
        <div id="mobileTimeDisplay" class="px-3 py-2 text-xs text-indigo-600 text-right border-b border-gray-100 mb-2"></div>
        <a href="/admin/dashboard" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-chart-line w-6 text-center mr-2"></i>ä»ªè¡¨ç›˜
        </a>
        <a href="/admin" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-list w-6 text-center mr-2"></i>è®¢é˜…åˆ—è¡¨
        </a>
        <a href="/admin/config" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-cog w-6 text-center mr-2"></i>ç³»ç»Ÿé…ç½®
        </a>
        <a href="/api/logout" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 active:bg-red-100 transition-colors">
          <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>é€€å‡ºç™»å½•
        </a>
      </div>
    </div>
  </nav>
  
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">ç³»ç»Ÿé…ç½®</h2>
      
      <form id="configForm" class="space-y-8">
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">ç®¡ç†å‘˜è´¦æˆ·</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="adminUsername" class="block text-sm font-medium text-gray-700">ç”¨æˆ·å</label>
              <input type="text" id="adminUsername" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div>
              <label for="adminPassword" class="block text-sm font-medium text-gray-700">å¯†ç </label>
              <input type="password" id="adminPassword" placeholder="å¦‚ä¸ä¿®æ”¹å¯†ç ï¼Œè¯·ç•™ç©º" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <p class="mt-1 text-sm text-gray-500">ç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹å½“å‰å¯†ç </p>
            </div>
          </div>
        </div>
        
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">æ˜¾ç¤ºè®¾ç½®</h3>
          
          <div class="mb-6">
            <label for="themeModeSelect" class="block text-sm font-medium text-gray-700 mb-1">ä¸»é¢˜æ¨¡å¼</label>
            <select id="themeModeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white sm:text-sm">
              <option value="light">ğŸŒ æµ…è‰²æ¨¡å¼</option>
              <option value="dark">ğŸŒ™ æš—é»‘æ¨¡å¼</option>
              <option value="system">ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ</option>
            </select>
            <p class="mt-1 text-sm text-gray-500">é€‰æ‹©ç³»ç»Ÿçš„å¤–è§‚é£æ ¼</p>
          </div>
          
          <div class="mb-6">
            <label class="inline-flex items-center">
              <input type="checkbox" id="showLunarGlobal" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
              <span class="ml-2 text-sm text-gray-700">åœ¨é€šçŸ¥ä¸­æ˜¾ç¤ºå†œå†æ—¥æœŸ</span>
            </label>
            <p class="mt-1 text-sm text-gray-500">æ§åˆ¶æ˜¯å¦åœ¨é€šçŸ¥æ¶ˆæ¯ä¸­åŒ…å«å†œå†æ—¥æœŸä¿¡æ¯</p>
          </div>
        </div>


        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">æ—¶åŒºè®¾ç½®</h3>
          <div class="mb-6">
          <label for="timezone" class="block text-sm font-medium text-gray-700 mb-1">æ—¶åŒºé€‰æ‹©</label>
          <select id="timezone" name="timezone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
            <option value="UTC">ä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼ˆUTC+0ï¼‰</option>
            <option value="Asia/Shanghai">ä¸­å›½æ ‡å‡†æ—¶é—´ï¼ˆUTC+8ï¼‰</option>
            <option value="Asia/Hong_Kong">é¦™æ¸¯æ—¶é—´ï¼ˆUTC+8ï¼‰</option>
            <option value="Asia/Taipei">å°åŒ—æ—¶é—´ï¼ˆUTC+8ï¼‰</option>
            <option value="Asia/Singapore">æ–°åŠ å¡æ—¶é—´ï¼ˆUTC+8ï¼‰</option>
            <option value="Asia/Tokyo">æ—¥æœ¬æ—¶é—´ï¼ˆUTC+9ï¼‰</option>
            <option value="Asia/Seoul">éŸ©å›½æ—¶é—´ï¼ˆUTC+9ï¼‰</option>
            <option value="America/New_York">ç¾å›½ä¸œéƒ¨æ—¶é—´ï¼ˆUTC-5ï¼‰</option>
            <option value="America/Chicago">ç¾å›½ä¸­éƒ¨æ—¶é—´ï¼ˆUTC-6ï¼‰</option>
            <option value="America/Denver">ç¾å›½å±±åœ°æ—¶é—´ï¼ˆUTC-7ï¼‰</option>
            <option value="America/Los_Angeles">ç¾å›½å¤ªå¹³æ´‹æ—¶é—´ï¼ˆUTC-8ï¼‰</option>
            <option value="Europe/London">è‹±å›½æ—¶é—´ï¼ˆUTC+0ï¼‰</option>
            <option value="Europe/Paris">å·´é»æ—¶é—´ï¼ˆUTC+1ï¼‰</option>
            <option value="Europe/Berlin">æŸæ—æ—¶é—´ï¼ˆUTC+1ï¼‰</option>
            <option value="Europe/Moscow">è«æ–¯ç§‘æ—¶é—´ï¼ˆUTC+3ï¼‰</option>
            <option value="Australia/Sydney">æ‚‰å°¼æ—¶é—´ï¼ˆUTC+10ï¼‰</option>
            <option value="Australia/Melbourne">å¢¨å°”æœ¬æ—¶é—´ï¼ˆUTC+10ï¼‰</option>
            <option value="Pacific/Auckland">å¥¥å…‹å…°æ—¶é—´ï¼ˆUTC+12ï¼‰</option>
          </select>
            <p class="mt-1 text-sm text-gray-500">è¯¥é¡¹ä»…ç”¨äºå…¼å®¹æ—§é…ç½®ä¸å±•ç¤ºå‚è€ƒï¼›åç«¯è°ƒåº¦ä¸æé†’è®¡ç®—ç»Ÿä¸€ä½¿ç”¨ UTCï¼Œé¡µé¢æ—¶é—´å§‹ç»ˆæŒ‰å½“å‰è®¾å¤‡æ—¶åŒºæ˜¾ç¤ºã€‚</p>
          </div>
        </div>

        
        <div class="border-b border-gray-200 pb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">é€šçŸ¥è®¾ç½®</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label for="notificationHours" class="block text-sm font-medium text-gray-700">é€šçŸ¥æ—¶æ®µï¼ˆUTCï¼‰</label>
              <input type="text" id="notificationHours" placeholder="ä¾‹å¦‚ï¼š08, 12, 20 æˆ–è¾“å…¥ * è¡¨ç¤ºå…¨å¤©"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <p class="mt-1 text-sm text-gray-500">å¯è¾“å…¥å¤šä¸ªå°æ—¶ï¼Œä½¿ç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”ï¼›ç•™ç©ºåˆ™é»˜è®¤æ¯å¤©æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡å³å¯</p>
            </div>
            <div class="bg-indigo-50 border border-indigo-100 rounded-md p-3 text-sm text-indigo-700">
              <p class="font-medium mb-1">æç¤º</p>
              <p>åå°ç»Ÿä¸€æŒ‰ UTC åˆ¤æ–­é€šçŸ¥æ—¶æ®µã€‚ç¤ºä¾‹ï¼šåŒ—äº¬æ—¶é—´ 08:00 å¯¹åº” UTC 00ï¼Œè¯·åœ¨æ­¤å¡« <code>00</code>ã€‚</p>
              <p class="mt-1">è‹¥ Cron å·²è®¾ç½®ä¸ºæ¯å°æ—¶æ‰§è¡Œï¼Œå¯ç”¨è¯¥å­—æ®µé™åˆ¶å®é™…å‘é€æé†’çš„å°æ—¶æ®µã€‚</p>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">é€šçŸ¥æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="telegram" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <span class="ml-2 text-sm text-gray-700">Telegram</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="notifyx" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                <span class="ml-2 text-sm text-gray-700 font-semibold">NotifyX</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="webhook" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <span class="ml-2 text-sm text-gray-700">Webhook é€šçŸ¥</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="wechatbot" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <span class="ml-2 text-sm text-gray-700">ä¼ä¸šå¾®ä¿¡æœºå™¨äºº</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="email" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <span class="ml-2 text-sm text-gray-700">é‚®ä»¶é€šçŸ¥</span>
              </label>
              <label class="inline-flex items-center">
                <input type="checkbox" name="enabledNotifiers" value="bark" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                <span class="ml-2 text-sm text-gray-700">Bark</span>
              </label>
            </div>
            <div class="mt-2 flex flex-wrap gap-4">
              <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-external-link-alt ml-1"></i> NotifyXå®˜ç½‘
              </a>
              <a href="https://webhook.site" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-external-link-alt ml-1"></i> Webhook è°ƒè¯•å·¥å…·
              </a>
              <a href="https://developer.work.weixin.qq.com/document/path/91770" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-external-link-alt ml-1"></i> ä¼ä¸šå¾®ä¿¡æœºå™¨äººæ–‡æ¡£
              </a>
              <a href="https://developers.cloudflare.com/workers/tutorials/send-emails-with-resend/" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-external-link-alt ml-1"></i> è·å– Resend API Key
              </a>
              <a href="https://apps.apple.com/cn/app/bark-customed-notifications/id1403753865" target="_blank" class="text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="fas fa-external-link-alt ml-1"></i> Bark iOSåº”ç”¨
              </a>
            </div>
          </div>

          <div class="mb-6">
            <label for="thirdPartyToken" class="block text-sm font-medium text-gray-700">ç¬¬ä¸‰æ–¹ API è®¿é—®ä»¤ç‰Œ</label>
            <div class="mt-1 flex flex-col sm:flex-row sm:items-center gap-3">
              <input type="text" id="thirdPartyToken" placeholder="å»ºè®®ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼šiH5s9vB3..."
                class="flex-1 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <button type="button" id="generateThirdPartyToken" class="btn-info text-white px-4 py-2 rounded-md text-sm font-medium whitespace-nowrap">
                <i class="fas fa-magic mr-2"></i>ç”Ÿæˆä»¤ç‰Œ
              </button>
            </div>
            <p class="mt-1 text-sm text-gray-500">è°ƒç”¨ /api/notify/{token} æ¥å£æ—¶éœ€æºå¸¦æ­¤ä»¤ç‰Œï¼›ç•™ç©ºè¡¨ç¤ºç¦ç”¨ç¬¬ä¸‰æ–¹ API æ¨é€ã€‚</p>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">è°ƒè¯•è®¾ç½®</label>
            <label class="inline-flex items-center cursor-pointer select-none">
              <input type="checkbox" id="debugLogs" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              <span class="ml-2 text-sm text-gray-700">å¼€å¯è°ƒè¯•æ—¥å¿—ï¼ˆå½±å“æ§åˆ¶å°è¾“å‡ºï¼‰</span>
            </label>
          </div>

          <div class="mb-6">
            <label for="paymentHistoryLimit" class="block text-sm font-medium text-gray-700">æ”¯ä»˜å†å²ä¿ç•™æ¡æ•°</label>
            <input type="number" id="paymentHistoryLimit" min="10" max="1000" step="1"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
              placeholder="é»˜è®¤ 100">
            <p class="mt-1 text-sm text-gray-500">è‡ªåŠ¨ç»­è®¢ä¸æ‰‹åŠ¨ç»­è®¢åä»…ä¿ç•™æœ€è¿‘ N æ¡æ”¯ä»˜å†å²ï¼ˆå»ºè®® 50~200ï¼Œé»˜è®¤ 100ï¼‰ã€‚</p>
          </div>
          
          <div id="telegramConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">Telegram é…ç½®</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="tgBotToken" class="block text-sm font-medium text-gray-700">Bot Token</label>
                <input type="text" id="tgBotToken" placeholder="ä» @BotFather è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              </div>
              <div>
                <label for="tgChatId" class="block text-sm font-medium text-gray-700">Chat ID</label>
                <input type="text" id="tgChatId" placeholder="å¯ä» @userinfobot è·å–" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testTelegramBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• Telegram é€šçŸ¥
              </button>
            </div>
          </div>
          
          <div id="notifyxConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">NotifyX é…ç½®</h4>
            <div class="mb-4">
              <label for="notifyxApiKey" class="block text-sm font-medium text-gray-700">API Key</label>
              <input type="text" id="notifyxApiKey" placeholder="ä» NotifyX å¹³å°è·å–çš„ API Key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
              <p class="mt-1 text-sm text-gray-500">ä» <a href="https://www.notifyx.cn/" target="_blank" class="text-indigo-600 hover:text-indigo-800">NotifyXå¹³å°</a> è·å–çš„ API Key</p>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testNotifyXBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• NotifyX é€šçŸ¥
              </button>
            </div>
          </div>

          <div id="webhookConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">Webhook é€šçŸ¥ é…ç½®</h4>
            <div class="grid grid-cols-1 gap-4 mb-4">
              <div>
                <label for="webhookUrl" class="block text-sm font-medium text-gray-700">Webhook é€šçŸ¥ URL</label>
                <input type="url" id="webhookUrl" placeholder="https://your-webhook-endpoint.com/path" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">è¯·å¡«å†™è‡ªå»ºæœåŠ¡æˆ–ç¬¬ä¸‰æ–¹å¹³å°æä¾›çš„ Webhook åœ°å€ï¼Œä¾‹å¦‚ <code>https://your-webhook-endpoint.com/path</code></p>
              </div>
              <div>
                <label for="webhookMethod" class="block text-sm font-medium text-gray-700">è¯·æ±‚æ–¹æ³•</label>
                <select id="webhookMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <option value="POST">POST</option>
                  <option value="GET">GET</option>
                  <option value="PUT">PUT</option>
                </select>
              </div>
              <div>
                <label for="webhookHeaders" class="block text-sm font-medium text-gray-700">è‡ªå®šä¹‰è¯·æ±‚å¤´ (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                <textarea id="webhookHeaders" rows="3" placeholder='{"Authorization": "Bearer your-token", "Content-Type": "application/json"}' class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                <p class="mt-1 text-sm text-gray-500">JSONæ ¼å¼çš„è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤</p>
              </div>
              <div>
                <label for="webhookTemplate" class="block text-sm font-medium text-gray-700">æ¶ˆæ¯æ¨¡æ¿ (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
                <textarea id="webhookTemplate" rows="4" placeholder='{"title": "{{title}}", "content": "{{content}}", "timestamp": "{{timestamp}}"}' class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                <p class="mt-1 text-sm text-gray-500">æ”¯æŒå˜é‡: {{title}}, {{content}}, {{timestamp}}ã€‚ç•™ç©ºä½¿ç”¨é»˜è®¤æ ¼å¼</p>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testWebhookBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• Webhook é€šçŸ¥
              </button>
            </div>
          </div>

          <div id="wechatbotConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">ä¼ä¸šå¾®ä¿¡æœºå™¨äºº é…ç½®</h4>
            <div class="grid grid-cols-1 gap-4 mb-4">
              <div>
                <label for="wechatbotWebhook" class="block text-sm font-medium text-gray-700">æœºå™¨äºº Webhook URL</label>
                <input type="url" id="wechatbotWebhook" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">ä»ä¼ä¸šå¾®ä¿¡ç¾¤èŠä¸­æ·»åŠ æœºå™¨äººè·å–çš„ Webhook URL</p>
              </div>
              <div>
                <label for="wechatbotMsgType" class="block text-sm font-medium text-gray-700">æ¶ˆæ¯ç±»å‹</label>
                <select id="wechatbotMsgType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <option value="text">æ–‡æœ¬æ¶ˆæ¯</option>
                  <option value="markdown">Markdownæ¶ˆæ¯</option>
                </select>
                <p class="mt-1 text-sm text-gray-500">é€‰æ‹©å‘é€çš„æ¶ˆæ¯æ ¼å¼ç±»å‹</p>
              </div>
              <div>
                <label for="wechatbotAtMobiles" class="block text-sm font-medium text-gray-700">@æ‰‹æœºå· (å¯é€‰)</label>
                <input type="text" id="wechatbotAtMobiles" placeholder="13800138000,13900139000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">éœ€è¦@çš„æ‰‹æœºå·ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™ä¸@ä»»ä½•äºº</p>
              </div>
              <div>
                <label for="wechatbotAtAll" class="block text-sm font-medium text-gray-700 mb-2">@æ‰€æœ‰äºº</label>
                <label class="inline-flex items-center">
                  <input type="checkbox" id="wechatbotAtAll" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">å‘é€æ¶ˆæ¯æ—¶@æ‰€æœ‰äºº</span>
                </label>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testWechatBotBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• ä¼ä¸šå¾®ä¿¡æœºå™¨äºº
              </button>
            </div>
          </div>

          <div id="emailConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">é‚®ä»¶é€šçŸ¥ é…ç½®</h4>
            <div class="grid grid-cols-1 gap-4 mb-4">
              <div>
                <label for="resendApiKey" class="block text-sm font-medium text-gray-700">Resend API Key</label>
                <input type="text" id="resendApiKey" placeholder="re_xxxxxxxxxx" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">ä» <a href="https://resend.com/api-keys" target="_blank" class="text-indigo-600 hover:text-indigo-800">Resendæ§åˆ¶å°</a> è·å–çš„ API Key</p>
              </div>
              <div>
                <label for="emailFrom" class="block text-sm font-medium text-gray-700">å‘ä»¶äººé‚®ç®±</label>
                <input type="email" id="emailFrom" placeholder="noreply@yourdomain.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">å¿…é¡»æ˜¯å·²åœ¨ResendéªŒè¯çš„åŸŸåé‚®ç®±</p>
              </div>
              <div>
                <label for="emailFromName" class="block text-sm font-medium text-gray-700">å‘ä»¶äººåç§°</label>
                <input type="text" id="emailFromName" placeholder="è®¢é˜…æé†’ç³»ç»Ÿ" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">æ˜¾ç¤ºåœ¨é‚®ä»¶ä¸­çš„å‘ä»¶äººåç§°</p>
              </div>
              <div>
                <label for="emailTo" class="block text-sm font-medium text-gray-700">æ”¶ä»¶äººé‚®ç®±</label>
                <input type="email" id="emailTo" placeholder="user@example.com" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">æ¥æ”¶é€šçŸ¥é‚®ä»¶çš„é‚®ç®±åœ°å€</p>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testEmailBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• é‚®ä»¶é€šçŸ¥
              </button>
            </div>
          </div>

          <div id="barkConfig" class="config-section">
            <h4 class="text-md font-medium text-gray-900 mb-3">Bark é…ç½®</h4>
            <div class="grid grid-cols-1 gap-4 mb-4">
              <div>
                <label for="barkServer" class="block text-sm font-medium text-gray-700">æœåŠ¡å™¨åœ°å€</label>
                <input type="url" id="barkServer" placeholder="https://api.day.app" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">Bark æœåŠ¡å™¨åœ°å€ï¼Œé»˜è®¤ä¸ºå®˜æ–¹æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨</p>
              </div>
              <div>
                <label for="barkDeviceKey" class="block text-sm font-medium text-gray-700">è®¾å¤‡Key</label>
                <input type="text" id="barkDeviceKey" placeholder="ä»Barkåº”ç”¨è·å–çš„è®¾å¤‡Key" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <p class="mt-1 text-sm text-gray-500">ä» <a href="https://apps.apple.com/cn/app/bark-customed-notifications/id1403753865" target="_blank" class="text-indigo-600 hover:text-indigo-800">Bark iOS åº”ç”¨</a> ä¸­è·å–çš„è®¾å¤‡Key</p>
              </div>
              <div>
                <label for="barkIsArchive" class="block text-sm font-medium text-gray-700 mb-2">ä¿å­˜æ¨é€</label>
                <label class="inline-flex items-center">
                  <input type="checkbox" id="barkIsArchive" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-700">ä¿å­˜æ¨é€åˆ°å†å²è®°å½•</span>
                </label>
                <p class="mt-1 text-sm text-gray-500">å‹¾é€‰åæ¨é€æ¶ˆæ¯ä¼šä¿å­˜åˆ° Bark çš„å†å²è®°å½•ä¸­</p>
              </div>
            </div>
            <div class="flex justify-end">
              <button type="button" id="testBarkBtn" class="btn-secondary text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-paper-plane mr-2"></i>æµ‹è¯• Bark é€šçŸ¥
              </button>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="btn-primary text-white px-6 py-2 rounded-md text-sm font-medium">
            <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function showToast(message, type = 'success', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      
      const icon = type === 'success' ? 'check-circle' :
                   type === 'error' ? 'exclamation-circle' :
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';
      
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    async function loadConfig() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();

        document.getElementById('adminUsername').value = config.ADMIN_USERNAME || '';
        document.getElementById('themeModeSelect').value = config.THEME_MODE || 'system';  // å›æ˜¾ä¸»é¢˜è®¾ç½®
        document.getElementById('tgBotToken').value = config.TG_BOT_TOKEN || '';
        document.getElementById('tgChatId').value = config.TG_CHAT_ID || '';
        document.getElementById('notifyxApiKey').value = config.NOTIFYX_API_KEY || '';
        document.getElementById('webhookUrl').value = config.WEBHOOK_URL || '';
        document.getElementById('webhookMethod').value = config.WEBHOOK_METHOD || 'POST';
        document.getElementById('webhookHeaders').value = config.WEBHOOK_HEADERS || '';
        document.getElementById('webhookTemplate').value = config.WEBHOOK_TEMPLATE || '';
        document.getElementById('wechatbotWebhook').value = config.WECHATBOT_WEBHOOK || '';
        document.getElementById('wechatbotMsgType').value = config.WECHATBOT_MSG_TYPE || 'text';
        document.getElementById('wechatbotAtMobiles').value = config.WECHATBOT_AT_MOBILES || '';
        document.getElementById('wechatbotAtAll').checked = config.WECHATBOT_AT_ALL === 'true';
        document.getElementById('resendApiKey').value = config.RESEND_API_KEY || '';
        document.getElementById('emailFrom').value = config.EMAIL_FROM || '';
        document.getElementById('emailFromName').value = config.EMAIL_FROM_NAME || 'è®¢é˜…æé†’ç³»ç»Ÿ';
        document.getElementById('emailTo').value = config.EMAIL_TO || '';
        document.getElementById('barkServer').value = config.BARK_SERVER || 'https://api.day.app';
        document.getElementById('barkDeviceKey').value = config.BARK_DEVICE_KEY || '';
        document.getElementById('barkIsArchive').checked = config.BARK_IS_ARCHIVE === 'true';
        document.getElementById('thirdPartyToken').value = config.THIRD_PARTY_API_TOKEN || '';
        document.getElementById('debugLogs').checked = config.DEBUG_LOGS === true;
        document.getElementById('paymentHistoryLimit').value = Number(config.PAYMENT_HISTORY_LIMIT) || 100;
        const notificationHoursInput = document.getElementById('notificationHours');
        if (notificationHoursInput) {
          // å°†é€šçŸ¥å°æ—¶æ•°ç»„æ ¼å¼åŒ–ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œä¾¿äºç®¡ç†å‘˜æŸ¥çœ‹ä¸ç¼–è¾‘
          const hours = Array.isArray(config.NOTIFICATION_HOURS) ? config.NOTIFICATION_HOURS : [];
          notificationHoursInput.value = hours.join(', ');
        }
        
        // åŠ è½½å†œå†æ˜¾ç¤ºè®¾ç½®
        document.getElementById('showLunarGlobal').checked = config.SHOW_LUNAR === true;

        // åŠ¨æ€ç”Ÿæˆæ—¶åŒºé€‰é¡¹ï¼Œå¹¶è®¾ç½®ä¿å­˜çš„å€¼
        generateTimezoneOptions(config.TIMEZONE || 'UTC');

        // å¤„ç†å¤šé€‰é€šçŸ¥æ¸ é“
        const enabledNotifiers = config.ENABLED_NOTIFIERS || ['notifyx'];
        document.querySelectorAll('input[name="enabledNotifiers"]').forEach(checkbox => {
          checkbox.checked = enabledNotifiers.includes(checkbox.value);
        });

        toggleNotificationConfigs(enabledNotifiers);
      } catch (error) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
        showToast('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
      }
    }
    
    // åŠ¨æ€ç”Ÿæˆæ—¶åŒºé€‰é¡¹
    function generateTimezoneOptions(selectedTimezone = 'UTC') {
      const timezoneSelect = document.getElementById('timezone');
      const fallbackTimezone = 'UTC';
      
      const timezones = [
        { value: 'UTC', name: 'ä¸–ç•Œæ ‡å‡†æ—¶é—´', offset: '+0' },
        { value: 'Asia/Shanghai', name: 'ä¸­å›½æ ‡å‡†æ—¶é—´', offset: '+8' },
        { value: 'Asia/Hong_Kong', name: 'é¦™æ¸¯æ—¶é—´', offset: '+8' },
        { value: 'Asia/Taipei', name: 'å°åŒ—æ—¶é—´', offset: '+8' },
        { value: 'Asia/Singapore', name: 'æ–°åŠ å¡æ—¶é—´', offset: '+8' },
        { value: 'Asia/Tokyo', name: 'æ—¥æœ¬æ—¶é—´', offset: '+9' },
        { value: 'Asia/Seoul', name: 'éŸ©å›½æ—¶é—´', offset: '+9' },
        { value: 'America/New_York', name: 'ç¾å›½ä¸œéƒ¨æ—¶é—´', offset: '-5' },
        { value: 'America/Chicago', name: 'ç¾å›½ä¸­éƒ¨æ—¶é—´', offset: '-6' },
        { value: 'America/Denver', name: 'ç¾å›½å±±åœ°æ—¶é—´', offset: '-7' },
        { value: 'America/Los_Angeles', name: 'ç¾å›½å¤ªå¹³æ´‹æ—¶é—´', offset: '-8' },
        { value: 'Europe/London', name: 'è‹±å›½æ—¶é—´', offset: '+0' },
        { value: 'Europe/Paris', name: 'å·´é»æ—¶é—´', offset: '+1' },
        { value: 'Europe/Berlin', name: 'æŸæ—æ—¶é—´', offset: '+1' },
        { value: 'Europe/Moscow', name: 'è«æ–¯ç§‘æ—¶é—´', offset: '+3' },
        { value: 'Australia/Sydney', name: 'æ‚‰å°¼æ—¶é—´', offset: '+10' },
        { value: 'Australia/Melbourne', name: 'å¢¨å°”æœ¬æ—¶é—´', offset: '+10' },
        { value: 'Pacific/Auckland', name: 'å¥¥å…‹å…°æ—¶é—´', offset: '+12' }
      ];
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      timezoneSelect.innerHTML = '';
      
      // æ·»åŠ æ–°é€‰é¡¹
      timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz.value;
        option.textContent = tz.name + 'ï¼ˆUTC' + tz.offset + 'ï¼‰';
        timezoneSelect.appendChild(option);
      });

      const timezoneExists = timezones.some(tz => tz.value === selectedTimezone);
      timezoneSelect.value = timezoneExists ? selectedTimezone : fallbackTimezone;

      if (!timezoneExists) {
        showToast('æ£€æµ‹åˆ°æœªçŸ¥æ—¶åŒºé…ç½®ï¼Œå·²å›é€€ä¸º UTCï¼Œè¯·é‡æ–°ç¡®è®¤åä¿å­˜', 'warning', 4500);
      }
    }
    
    function toggleNotificationConfigs(enabledNotifiers) {
      const telegramConfig = document.getElementById('telegramConfig');
      const notifyxConfig = document.getElementById('notifyxConfig');
      const webhookConfig = document.getElementById('webhookConfig');
      const wechatbotConfig = document.getElementById('wechatbotConfig');
      const emailConfig = document.getElementById('emailConfig');
      const barkConfig = document.getElementById('barkConfig');

      // é‡ç½®æ‰€æœ‰é…ç½®åŒºåŸŸ
      [telegramConfig, notifyxConfig, webhookConfig, wechatbotConfig, emailConfig, barkConfig].forEach(config => {
        config.classList.remove('active', 'inactive');
        config.classList.add('inactive');
      });

      // æ¿€æ´»é€‰ä¸­çš„é…ç½®åŒºåŸŸ
      enabledNotifiers.forEach(type => {
        if (type === 'telegram') {
          telegramConfig.classList.remove('inactive');
          telegramConfig.classList.add('active');
        } else if (type === 'notifyx') {
          notifyxConfig.classList.remove('inactive');
          notifyxConfig.classList.add('active');
        } else if (type === 'webhook') {
          webhookConfig.classList.remove('inactive');
          webhookConfig.classList.add('active');
        } else if (type === 'wechatbot') {
          wechatbotConfig.classList.remove('inactive');
          wechatbotConfig.classList.add('active');
        } else if (type === 'email') {
          emailConfig.classList.remove('inactive');
          emailConfig.classList.add('active');
        } else if (type === 'bark') {
          barkConfig.classList.remove('inactive');
          barkConfig.classList.add('active');
        }
      });
    }

    document.querySelectorAll('input[name="enabledNotifiers"]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const enabledNotifiers = Array.from(document.querySelectorAll('input[name="enabledNotifiers"]:checked'))
          .map(cb => cb.value);
        toggleNotificationConfigs(enabledNotifiers);
      });
    });
    
    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const enabledNotifiers = Array.from(document.querySelectorAll('input[name="enabledNotifiers"]:checked'))
        .map(cb => cb.value);

      if (enabledNotifiers.length === 0) {
        showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é€šçŸ¥æ–¹å¼', 'warning');
        return;
      }

      const config = {
        ADMIN_USERNAME: document.getElementById('adminUsername').value.trim(),
        THEME_MODE: document.getElementById('themeModeSelect').value,      // ä¿å­˜ä¸»é¢˜è®¾ç½®
        TG_BOT_TOKEN: document.getElementById('tgBotToken').value.trim(),
        TG_CHAT_ID: document.getElementById('tgChatId').value.trim(),
        NOTIFYX_API_KEY: document.getElementById('notifyxApiKey').value.trim(),
        WEBHOOK_URL: document.getElementById('webhookUrl').value.trim(),
        WEBHOOK_METHOD: document.getElementById('webhookMethod').value,
        WEBHOOK_HEADERS: document.getElementById('webhookHeaders').value.trim(),
        WEBHOOK_TEMPLATE: document.getElementById('webhookTemplate').value.trim(),
        SHOW_LUNAR: document.getElementById('showLunarGlobal').checked,
        WECHATBOT_WEBHOOK: document.getElementById('wechatbotWebhook').value.trim(),
        WECHATBOT_MSG_TYPE: document.getElementById('wechatbotMsgType').value,
        WECHATBOT_AT_MOBILES: document.getElementById('wechatbotAtMobiles').value.trim(),
        WECHATBOT_AT_ALL: document.getElementById('wechatbotAtAll').checked.toString(),
        RESEND_API_KEY: document.getElementById('resendApiKey').value.trim(),
        EMAIL_FROM: document.getElementById('emailFrom').value.trim(),
        EMAIL_FROM_NAME: document.getElementById('emailFromName').value.trim(),
        EMAIL_TO: document.getElementById('emailTo').value.trim(),
        BARK_SERVER: document.getElementById('barkServer').value.trim() || 'https://api.day.app',
        BARK_DEVICE_KEY: document.getElementById('barkDeviceKey').value.trim(),
        BARK_IS_ARCHIVE: document.getElementById('barkIsArchive').checked.toString(),
        ENABLED_NOTIFIERS: enabledNotifiers,
        TIMEZONE: document.getElementById('timezone').value.trim(),
        THIRD_PARTY_API_TOKEN: document.getElementById('thirdPartyToken').value.trim(),
        DEBUG_LOGS: document.getElementById('debugLogs').checked === true,
        PAYMENT_HISTORY_LIMIT: (() => {
          const raw = Number(document.getElementById('paymentHistoryLimit').value);
          if (!Number.isFinite(raw)) return 100;
          return Math.min(1000, Math.max(10, Math.floor(raw)));
        })(),
        // å‰ç«¯å…ˆè¡Œæ•´ç†é€šçŸ¥å°æ—¶åˆ—è¡¨ï¼Œåç«¯ä»ä¼šå†æ¬¡æ ¡éªŒ
        NOTIFICATION_HOURS: (() => {
          const raw = document.getElementById('notificationHours').value.trim();
          if (!raw) {
            return [];
          }
          return raw
            .split(/[,ï¼Œ\s]+/)
            .map(item => item.trim())
            .filter(item => item.length > 0);
        })()
      };

      const passwordField = document.getElementById('adminPassword');
      if (passwordField.value.trim()) {
        config.ADMIN_PASSWORD = passwordField.value.trim();
      }

      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalContent = submitButton.innerHTML;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ä¿å­˜ä¸­...';
      submitButton.disabled = true;

      try {
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();

        if (result.success) {
          showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
          if (window.updateAppTheme) {    // ä¿å­˜æˆåŠŸåç«‹å³åº”ç”¨ä¸»é¢˜ï¼Œæ— éœ€åˆ·æ–°
            window.updateAppTheme(config.THEME_MODE);
          }
          passwordField.value = '';
          
          // å‰ç«¯å§‹ç»ˆæ˜¾ç¤ºæµè§ˆå™¨æœ¬åœ°æ—¶åŒº
          globalTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
          showSystemTime();
          
          // æ ‡è®°æ—¶åŒºå·²æ›´æ–°ï¼Œä¾›å…¶ä»–é¡µé¢æ£€æµ‹
          localStorage.setItem('timezoneUpdated', Date.now().toString());
          
          // å¦‚æœå½“å‰åœ¨è®¢é˜…åˆ—è¡¨é¡µé¢ï¼Œåˆ™è‡ªåŠ¨åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ—¶åŒºæ˜¾ç¤º
          if (window.location.pathname === '/admin') {
            window.location.reload();
          }
        } else {
          showToast('é…ç½®ä¿å­˜å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
        showToast('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
      } finally {
        submitButton.innerHTML = originalContent;
        submitButton.disabled = false;
      }
    });
    
    async function testNotification(type) {
      const buttonId = type === 'telegram' ? 'testTelegramBtn' :
                      type === 'notifyx' ? 'testNotifyXBtn' :
                      type === 'wechatbot' ? 'testWechatBotBtn' :
                      type === 'email' ? 'testEmailBtn' :
                      type === 'bark' ? 'testBarkBtn' : 'testWebhookBtn';
      const button = document.getElementById(buttonId);
      if (!button) {
        showToast('æµ‹è¯•æŒ‰é’®ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
        return;
      }
      const originalContent = button.innerHTML;
      const serviceName = type === 'telegram' ? 'Telegram' :
                          type === 'notifyx' ? 'NotifyX' :
                          type === 'wechatbot' ? 'ä¼ä¸šå¾®ä¿¡æœºå™¨äºº' :
                          type === 'email' ? 'é‚®ä»¶é€šçŸ¥' :
                          type === 'bark' ? 'Bark' : 'Webhook é€šçŸ¥';

      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
      button.disabled = true;

      const config = {};
      if (type === 'telegram') {
        config.TG_BOT_TOKEN = document.getElementById('tgBotToken').value.trim();
        config.TG_CHAT_ID = document.getElementById('tgChatId').value.trim();

        if (!config.TG_BOT_TOKEN || !config.TG_CHAT_ID) {
          showToast('è¯·å…ˆå¡«å†™ Telegram Bot Token å’Œ Chat ID', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      } else if (type === 'notifyx') {
        config.NOTIFYX_API_KEY = document.getElementById('notifyxApiKey').value.trim();

        if (!config.NOTIFYX_API_KEY) {
          showToast('è¯·å…ˆå¡«å†™ NotifyX API Key', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      } else if (type === 'webhook') {
        config.WEBHOOK_URL = document.getElementById('webhookUrl').value.trim();
        config.WEBHOOK_METHOD = document.getElementById('webhookMethod').value;
        config.WEBHOOK_HEADERS = document.getElementById('webhookHeaders').value.trim();
        config.WEBHOOK_TEMPLATE = document.getElementById('webhookTemplate').value.trim();

        if (!config.WEBHOOK_URL) {
          showToast('è¯·å…ˆå¡«å†™ Webhook é€šçŸ¥ URL', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      } else if (type === 'wechatbot') {
        config.WECHATBOT_WEBHOOK = document.getElementById('wechatbotWebhook').value.trim();
        config.WECHATBOT_MSG_TYPE = document.getElementById('wechatbotMsgType').value;
        config.WECHATBOT_AT_MOBILES = document.getElementById('wechatbotAtMobiles').value.trim();
        config.WECHATBOT_AT_ALL = document.getElementById('wechatbotAtAll').checked.toString();

        if (!config.WECHATBOT_WEBHOOK) {
          showToast('è¯·å…ˆå¡«å†™ä¼ä¸šå¾®ä¿¡æœºå™¨äºº Webhook URL', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      } else if (type === 'email') {
        config.RESEND_API_KEY = document.getElementById('resendApiKey').value.trim();
        config.EMAIL_FROM = document.getElementById('emailFrom').value.trim();
        config.EMAIL_FROM_NAME = document.getElementById('emailFromName').value.trim();
        config.EMAIL_TO = document.getElementById('emailTo').value.trim();

        if (!config.RESEND_API_KEY || !config.EMAIL_FROM || !config.EMAIL_TO) {
          showToast('è¯·å…ˆå¡«å†™ Resend API Keyã€å‘ä»¶äººé‚®ç®±å’Œæ”¶ä»¶äººé‚®ç®±', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      } else if (type === 'bark') {
        config.BARK_SERVER = document.getElementById('barkServer').value.trim() || 'https://api.day.app';
        config.BARK_DEVICE_KEY = document.getElementById('barkDeviceKey').value.trim();
        config.BARK_IS_ARCHIVE = document.getElementById('barkIsArchive').checked.toString();

        if (!config.BARK_DEVICE_KEY) {
          showToast('è¯·å…ˆå¡«å†™ Bark è®¾å¤‡Key', 'warning');
          button.innerHTML = originalContent;
          button.disabled = false;
          return;
        }
      }

      try {
        const response = await fetch('/api/test-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: type, ...config })
        });

        let result = null;
        try {
          result = await response.json();
        } catch (_) {
          result = { success: false, message: 'æœåŠ¡è¿”å›äº†æ— æ³•è§£æçš„å“åº”' };
        }

        if (response.ok && result.success) {
          showToast(serviceName + ' é€šçŸ¥æµ‹è¯•æˆåŠŸï¼', 'success');
        } else {
          const message = (result && result.message) ? result.message : ('HTTP ' + response.status);
          showToast(serviceName + ' é€šçŸ¥æµ‹è¯•å¤±è´¥: ' + message, 'error', 4500);
        }
      } catch (error) {
        console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
        showToast(serviceName + ' æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
      } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
      }
    }
    
    document.getElementById('testTelegramBtn').addEventListener('click', () => {
      testNotification('telegram');
    });
    
    document.getElementById('testNotifyXBtn').addEventListener('click', () => {
      testNotification('notifyx');
    });

    document.getElementById('testWebhookBtn').addEventListener('click', () => {
      testNotification('webhook');
    });

    document.getElementById('testWechatBotBtn').addEventListener('click', () => {
      testNotification('wechatbot');
    });

    document.getElementById('testEmailBtn').addEventListener('click', () => {
      testNotification('email');
    });

    document.getElementById('testBarkBtn').addEventListener('click', () => {
      testNotification('bark');
    });

    document.getElementById('generateThirdPartyToken').addEventListener('click', () => {
      try {
        // ç”Ÿæˆ 32 ä½éšæœºä»¤ç‰Œï¼Œé¿å…å‡ºç°ç‰¹æ®Šå­—ç¬¦ï¼Œæ–¹ä¾¿å†™å…¥ URL
        const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        const buffer = new Uint8Array(32);
        window.crypto.getRandomValues(buffer);
        const token = Array.from(buffer).map(v => charset[v % charset.length]).join('');
        const input = document.getElementById('thirdPartyToken');
        input.value = token;
        input.dispatchEvent(new Event('input'));
        showToast('å·²ç”Ÿæˆæ–°çš„ç¬¬ä¸‰æ–¹ API ä»¤ç‰Œï¼Œè¯·ä¿å­˜é…ç½®åç”Ÿæ•ˆ', 'info');
      } catch (error) {
        console.error('ç”Ÿæˆä»¤ç‰Œå¤±è´¥:', error);
        showToast('ç”Ÿæˆä»¤ç‰Œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥', 'error');
      }
    });

    window.addEventListener('load', loadConfig);
    
    // å‰ç«¯å±•ç¤ºæ—¶åŒºï¼ˆå›ºå®šä½¿ç”¨æµè§ˆå™¨æœ¬åœ°æ—¶åŒºï¼‰
    let globalTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    let systemTimeTimer = null;
    let timezoneCheckTimer = null;
    
    // å®æ—¶æ˜¾ç¤ºç³»ç»Ÿæ—¶é—´å’Œæ—¶åŒº
    async function showSystemTime() {
      try {
        // è·å–åå°é…ç½®çš„æ—¶åŒº
        const response = await fetch('/api/config');
        const config = await response.json();
        globalTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        
        // æ ¼å¼åŒ–å½“å‰æ—¶é—´
        function formatTime(dt, tz) {
          return dt.toLocaleString('zh-CN', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        function formatTimezoneDisplay(tz) {
          try {
            // ä½¿ç”¨æ›´å‡†ç¡®çš„æ—¶åŒºåç§»è®¡ç®—æ–¹æ³•
            const now = new Date();
            const dtf = new Intl.DateTimeFormat('en-US', {
              timeZone: tz,
              hour12: false,
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const parts = dtf.formatToParts(now);
            const get = type => Number(parts.find(x => x.type === type).value);
            const target = Date.UTC(get('year'), get('month') - 1, get('day'), get('hour'), get('minute'), get('second'));
            const utc = now.getTime();
            const offset = Math.round((target - utc) / (1000 * 60 * 60));
            
            // æ—¶åŒºä¸­æ–‡åç§°æ˜ å°„
            const timezoneNames = {
              'UTC': 'ä¸–ç•Œæ ‡å‡†æ—¶é—´',
              'Asia/Shanghai': 'ä¸­å›½æ ‡å‡†æ—¶é—´',
              'Asia/Hong_Kong': 'é¦™æ¸¯æ—¶é—´',
              'Asia/Taipei': 'å°åŒ—æ—¶é—´',
              'Asia/Singapore': 'æ–°åŠ å¡æ—¶é—´',
              'Asia/Tokyo': 'æ—¥æœ¬æ—¶é—´',
              'Asia/Seoul': 'éŸ©å›½æ—¶é—´',
              'America/New_York': 'ç¾å›½ä¸œéƒ¨æ—¶é—´',
              'America/Los_Angeles': 'ç¾å›½å¤ªå¹³æ´‹æ—¶é—´',
              'America/Chicago': 'ç¾å›½ä¸­éƒ¨æ—¶é—´',
              'America/Denver': 'ç¾å›½å±±åœ°æ—¶é—´',
              'Europe/London': 'è‹±å›½æ—¶é—´',
              'Europe/Paris': 'å·´é»æ—¶é—´',
              'Europe/Berlin': 'æŸæ—æ—¶é—´',
              'Europe/Moscow': 'è«æ–¯ç§‘æ—¶é—´',
              'Australia/Sydney': 'æ‚‰å°¼æ—¶é—´',
              'Australia/Melbourne': 'å¢¨å°”æœ¬æ—¶é—´',
              'Pacific/Auckland': 'å¥¥å…‹å…°æ—¶é—´'
            };
            
            const offsetStr = offset >= 0 ? '+' + offset : offset;
            const timezoneName = timezoneNames[tz] || tz;
            return timezoneName + ' (UTC' + offsetStr + ')';
          } catch (error) {
            console.error('æ ¼å¼åŒ–æ—¶åŒºæ˜¾ç¤ºå¤±è´¥:', error);
            return tz;
          }
        }
        function update() {
          const now = new Date();
          const timeStr = formatTime(now, globalTimezone);
          const tzStr = formatTimezoneDisplay(globalTimezone);
          const el = document.getElementById('systemTimeDisplay');
          if (el) {
            el.textContent = timeStr + '  ' + tzStr;
          }
          // æ›´æ–°ç§»åŠ¨ç«¯æ˜¾ç¤º (æ–°å¢)
          const mobileEl = document.getElementById('mobileTimeDisplay');
          if (mobileEl) {
            mobileEl.textContent = timeStr + ' ' + tzStr;
          }
        }
        update();

        if (systemTimeTimer) {
          clearInterval(systemTimeTimer);
        }
        systemTimeTimer = setInterval(update, 1000);

        if (timezoneCheckTimer) {
          clearInterval(timezoneCheckTimer);
        }
        timezoneCheckTimer = setInterval(async () => {
          try {
            const response = await fetch('/api/config');
            await response.json();
            const newTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

            if (globalTimezone !== newTimezone) {
              globalTimezone = newTimezone;
              update();
            }
          } catch (error) {
            console.error('æ£€æŸ¥æ—¶åŒºæ›´æ–°å¤±è´¥:', error);
          }
        }, 30000);
      } catch (e) {
        // å‡ºé”™æ—¶æ˜¾ç¤ºæœ¬åœ°æ—¶é—´
        const el = document.getElementById('systemTimeDisplay');
        if (el) {
          el.textContent = new Date().toLocaleString();
        }
      }
    }
    showSystemTime();
    // --- æ–°å¢ï¼šç§»åŠ¨ç«¯èœå•æ§åˆ¶è„šæœ¬ ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuBtn && mobileMenu) {
      const syncMobileMenuState = () => {
        const icon = mobileMenuBtn.querySelector('i');
        const isHidden = mobileMenu.classList.contains('hidden');
        mobileMenuBtn.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        if (icon) {
          icon.classList.toggle('fa-bars', isHidden);
          icon.classList.toggle('fa-times', !isHidden);
        }
      };

      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        syncMobileMenuState();
      });
      
      mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        });
      });

      document.addEventListener('click', (event) => {
        if (mobileMenu.classList.contains('hidden')) return;
        if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      syncMobileMenuState();
    }
  </script>
</body>
</html>