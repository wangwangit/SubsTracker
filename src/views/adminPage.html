
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¢é˜…ç®¡ç†ç³»ç»Ÿ</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  ${themeResources}  <style>
    .table-container { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    .modal-container { backdrop-filter: blur(8px); }
    .readonly-input { background-color: #f8fafc; border-color: #e2e8f0; cursor: not-allowed; }
    .error-message { font-size: 0.875rem; margin-top: 0.25rem; display: none; }
    .error-message.show { display: block; }

    /* é€šç”¨æ‚¬æµ®æç¤ºä¼˜åŒ– */
    .hover-container {
      position: relative;
      width: 100%;
    }
    .hover-text {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
    }
    .hover-text:hover { color: #3b82f6; }
    .hover-tooltip {
      position: fixed;
      z-index: 9999;
      background: #1f2937;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.875rem;
      max-width: 320px;
      word-wrap: break-word;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      transform: translateY(-10px);
      white-space: normal;
      pointer-events: none;
      line-height: 1.4;
    }
    .hover-tooltip.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .hover-tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #1f2937;
    }
    .hover-tooltip.tooltip-above::before {
      top: auto;
      bottom: -6px;
      border-bottom: none;
      border-top: 6px solid #1f2937;
    }

    /* å¤‡æ³¨æ˜¾ç¤ºä¼˜åŒ– */
    .notes-container {
      position: relative;
      max-width: 200px;
      width: 100%;
    }
    .notes-text {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      display: block;
    }
    .notes-text:hover { color: #3b82f6; }
    .notes-tooltip {
      position: fixed;
      z-index: 9999;
      background: #1f2937;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.875rem;
      max-width: 320px;
      word-wrap: break-word;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      transform: translateY(-10px);
      white-space: normal;
      pointer-events: none;
      line-height: 1.4;
    }
    .notes-tooltip.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .notes-tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 20px;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 6px solid #1f2937;
    }
    .notes-tooltip.tooltip-above::before {
      top: auto;
      bottom: -6px;
      border-bottom: none;
      border-top: 6px solid #1f2937;
    }

    /* å†œå†æ˜¾ç¤ºæ ·å¼ */
    .lunar-display {
      font-size: 0.75rem;
      color: #6366f1;
      margin-top: 2px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .lunar-display.show {
      opacity: 1;
    }
    
    .custom-date-picker {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      width: 100%;
      max-width: 380px;
      min-width: 300px; 
    }
    
    .custom-date-picker .calendar-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%; 
      height: auto;
      aspect-ratio: 0.85; /* ä¿æŒé€‚ä¸­çš„é•¿å®½æ¯”ï¼Œç´§å‡‘å¸ƒå±€ */
      min-height: 45px;   /* ä¿è¯æœ€å°ç‚¹å‡»åŒºåŸŸ */
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      padding: 2px; /* å‡å°å†…è¾¹è· */
      font-size: 13px; /* ç¨å¾®è°ƒå°å­—ä½“é€‚åº”ç§»åŠ¨ç«¯ */
    }
    /* ã€æ–°å¢ã€‘è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ (ç”¨äºæ›¿ä»£ datalist) */
    .custom-dropdown-wrapper {
      position: relative;
      width: 100%;
    }
    .custom-dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 60; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none; /* é»˜è®¤éšè— */
    }
    .custom-dropdown-list.show {
      display: block;
    }
    .dropdown-item {
      padding: 10px 12px;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }
    .dropdown-item:last-child {
      border-bottom: none;
    }
    .dropdown-item:hover, .dropdown-item:active {
      background-color: #f3f4f6;
      color: #4f46e5;
    }

    .custom-date-picker .calendar-day:hover {
      background-color: #e0e7ff;
      transform: scale(1.05);
    }
    
    .custom-date-picker .calendar-day.selected {
      background-color: #6366f1;
      color: white;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    
    .custom-date-picker .calendar-day.today {
      background-color: #e0e7ff;
      color: #6366f1;
      font-weight: 600;
      border: 2px solid #6366f1;
    }
    
    .custom-date-picker .calendar-day.other-month {
      color: #d1d5db;
    }
    
    .custom-date-picker .calendar-day .lunar-text {
      font-size: 11px;
      line-height: 1.2;
      margin-top: 3px;
      opacity: 0.85;
      text-align: center;
      font-weight: 500;
    }
    
    .custom-date-picker .calendar-day.selected .lunar-text {
      color: rgba(255, 255, 255, 0.9);
    }
    
    .custom-date-picker .calendar-day.today .lunar-text {
      color: #6366f1;
    }
    
    /* æœˆä»½å’Œå¹´ä»½é€‰æ‹©å™¨æ ·å¼ */
    .month-option, .year-option {
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .month-option:hover, .year-option:hover {
      background-color: #e0e7ff !important;
      border-color: #6366f1;
      color: #6366f1;
    }
    
    .month-option.selected, .year-option.selected {
      background-color: #6366f1 !important;
      color: white;
      border-color: #6366f1;
    }
    
    .lunar-toggle {
      display: inline-flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.875rem;
    }
    .lunar-toggle input[type="checkbox"] {
      margin-right: 6px;
    }

    /* è¡¨æ ¼å¸ƒå±€ä¼˜åŒ– */
    .table-container {
      width: 100%;
      overflow: hidden;
    }

    .table-container table {
      table-layout: fixed;
      width: 100%;
    }

    /* é˜²æ­¢è¡¨æ ¼å†…å®¹æº¢å‡º */
    .table-container td {
      overflow: hidden;
      word-wrap: break-word;
    }

    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* å“åº”å¼ä¼˜åŒ– */
    .responsive-table { table-layout: fixed; width: 100%; }
    .td-content-wrapper { word-wrap: break-word; white-space: normal; text-align: left; width: 100%; }
    .td-content-wrapper > * { text-align: left; } /* Align content left within the wrapper */

    @media (max-width: 767px) {
      .table-container { overflow: hidden; }
      .responsive-table thead { display: none; }
      .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
      .responsive-table tr { margin-bottom: 1.5rem; border: 1px solid #ddd; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden; }
      .responsive-table td { display: flex; justify-content: flex-start; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #eee; }
      .responsive-table td:last-of-type { border-bottom: none; }
      .responsive-table td:before { content: attr(data-label); font-weight: 600; text-align: left; padding-right: 1rem; color: #374151; white-space: nowrap; }
      .action-buttons-wrapper { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
      
      .notes-container, .hover-container {
        max-width: 180px; /* Adjust for new layout */
        text-align: right;
      }
      .td-content-wrapper .notes-text {
        text-align: right;
      }
     }
    @media (max-width: 767px) {
      #systemTimeDisplay {
        display: none !important;
      }
    }
    @media (min-width: 768px) {
      .table-container { overflow: hidden; }
      /* .td-content-wrapper is aligned left by default */
    }

    /* Toast æ ·å¼ */
    .toast {
      position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
      color: white; font-weight: 500; z-index: 1000; transform: translateX(400px);
      transition: all 0.3s ease-in-out; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background-color: #10b981; }
    .toast.error { background-color: #ef4444; }
    .toast.info { background-color: #3b82f6; }
    .toast.warning { background-color: #f59e0b; }
    html.dark .toast {
      color: #f9fafb;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.45);
    }
    html.dark .toast.success { background-color: #059669; }
    html.dark .toast.error { background-color: #dc2626; }
    html.dark .toast.info { background-color: #2563eb; }
    html.dark .toast.warning { background-color: #d97706; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="toast-container"></div>

  <nav class="bg-white shadow-md relative z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center shrink-0">
          <div class="flex items-center">
            <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
          </div>
          <span id="systemTimeDisplay" class="ml-4 text-base text-indigo-600 font-normal hidden md:block pt-1"></span>
        </div>

        <div class="hidden md:flex items-center space-x-4 ml-auto">
          <a href="/admin/dashboard" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-chart-line mr-1"></i>ä»ªè¡¨ç›˜
          </a>
          <a href="/admin" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
          </a>
          <a href="/admin/config" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
          </a>
          <a href="/api/logout" class="text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
          </a>
        </div>

        <div class="flex items-center md:hidden ml-auto">
          <button id="mobile-menu-btn" type="button" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•" class="text-gray-600 hover:text-indigo-600 focus:outline-none p-2 rounded-md hover:bg-gray-100 active:bg-gray-200 transition-colors">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-b border-gray-200 w-full">
       <div class="px-4 pt-2 pb-4 space-y-2">
        <div id="mobileTimeDisplay" class="px-3 py-2 text-xs text-indigo-600 text-right border-b border-gray-100 mb-2"></div>
        <a href="/admin/dashboard" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-chart-line w-6 text-center mr-2"></i>ä»ªè¡¨ç›˜
        </a>
        <a href="/admin" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-list w-6 text-center mr-2"></i>è®¢é˜…åˆ—è¡¨
        </a>
        <a href="/admin/config" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-cog w-6 text-center mr-2"></i>ç³»ç»Ÿé…ç½®
        </a>
        <a href="/api/logout" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 active:bg-red-100 transition-colors">
          <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>é€€å‡ºç™»å½•
        </a>
      </div>
    </div>
  </nav>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">è®¢é˜…åˆ—è¡¨</h2>
        <p class="text-sm text-gray-500 mt-1">ä½¿ç”¨æœç´¢ä¸åˆ†ç±»å¿«é€Ÿå®šä½è®¢é˜…ï¼Œå¼€å¯å†œå†æ˜¾ç¤ºå¯åŒæ­¥æŸ¥çœ‹å†œå†æ—¥æœŸ</p>
      </div>
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 w-full">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3 w-full lg:flex-1 lg:max-w-2xl">
          <div class="relative flex-1 min-w-[200px] lg:max-w-md">
            <input type="text" id="searchKeyword" placeholder="æœç´¢åç§°ã€ç±»å‹æˆ–å¤‡æ³¨..." class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
              <i class="fas fa-search"></i>
            </span>
          </div>
          <div class="sm:w-36 lg:w-32">
            <select id="modeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
              <option value="">å…¨éƒ¨æ¨¡å¼</option>
              <option value="cycle">å¾ªç¯è®¢é˜…</option>
              <option value="reset">åˆ°æœŸé‡ç½®</option>
            </select>
          </div>
          <div class="sm:w-44 lg:w-40">
            <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
              <option value="">å…¨éƒ¨åˆ†ç±»</option>
            </select>
          </div>

        </div>
        <div class="flex items-center space-x-3 lg:space-x-4">
        <label class="lunar-toggle">
          <input type="checkbox" id="listShowLunar" class="form-checkbox h-4 w-4 text-indigo-600 shrink-0">
          <span class="text-gray-700">æ˜¾ç¤ºå†œå†</span>
        </label>
        <button id="addSubscriptionBtn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center shrink-0">
          <i class="fas fa-plus mr-2"></i>æ·»åŠ æ–°è®¢é˜…
        </button>
      </div>
      </div>
    </div>
    
    <div class="table-container bg-white rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full divide-y divide-gray-200 responsive-table">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 23%;">
                åç§°
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 13%;">
                ç±»å‹
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 18%;">
                åˆ°æœŸ <i class="fas fa-sort-up ml-1 text-indigo-500" title="æŒ‰åˆ°æœŸæ—¶é—´å‡åºæ’åˆ—"></i>
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                é‡‘é¢
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 13%;">
                æé†’
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 10%;">
                çŠ¶æ€
              </th>
              <th scope="col" class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider" style="width: 13%;">
                æ“ä½œ
              </th>
            </tr>
          </thead>
        <tbody id="subscriptionsBody" class="bg-white divide-y divide-gray-200">
        </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="subscriptionModal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-gray-600 bg-opacity-50">
    <div class="relative w-auto max-w-2xl mx-4 md:mx-auto my-12 bg-white rounded-lg shadow-xl">
      <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
        <div class="flex items-center justify-between">
          <h3 id="modalTitle" class="text-lg font-medium text-gray-900">æ·»åŠ æ–°è®¢é˜…</h3>
          <button id="closeModal" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <form id="subscriptionForm" class="p-6 space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…åç§° *</label>
            <input type="text" id="name" required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
            <div class="error-message text-red-500" data-for="name"></div>
          </div>
          
          <div class="custom-dropdown-wrapper">
            <label for="customType" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…ç±»å‹</label>
            <input type="text" id="customType" placeholder="é€‰æ‹©æˆ–è¾“å…¥è‡ªå®šä¹‰ç±»å‹" autocomplete="off"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
            <div id="customTypeDropdown" class="custom-dropdown-list"></div>
          </div>

          <div class="custom-dropdown-wrapper">
            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»æ ‡ç­¾</label>
            <input type="text" id="category" placeholder="é€‰æ‹©æˆ–è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾" autocomplete="off"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
            <div id="categoryDropdown" class="custom-dropdown-list"></div>
            <p class="mt-1 text-xs text-gray-500">å¯è¾“å…¥å¤šä¸ªæ ‡ç­¾å¹¶ä½¿ç”¨"/"åˆ†éš”</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              è´¹ç”¨è®¾ç½® <span class="text-gray-400 text-xs ml-1">å¯é€‰</span>
            </label>
            <div class="flex space-x-2">
              <div class="w-24 shrink-0"> 
                <select id="currency" class="h-10 w-full px-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm">
                  <option value="CNY" selected>CNY (Â¥)</option>
                  <option value="USD">USD ($)</option>   // ç¾å…ƒ
                  <option value="HKD">HKD (HK$)</option> // æ¸¯å¸
                  <option value="TWD">TWD (NT$)</option> // æ–°å°å¸
                  <option value="JPY">JPY (Â¥)</option>   // æ—¥å…ƒ
                  <option value="EUR">EUR (â‚¬)</option>   // æ¬§å…ƒ
                  <option value="GBP">GBP (Â£)</option>   // è‹±é•‘
                  <option value="KRW">KRW (â‚©)</option>   // éŸ©å…ƒ
                  <option value="TRY">TRY (â‚º)</option>   // åœŸè€³å…¶é‡Œæ‹‰
                </select>
              </div>
              <div class="relative flex-1">
                <input type="number" id="amount" step="0.01" min="0" placeholder="ä¾‹å¦‚: 15.00"
                  class="h-10 w-full px-3 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
              </div>
            </div>
            <p class="mt-1 text-xs text-gray-500">ç”¨äºç»Ÿè®¡æ”¯å‡ºå’Œç”Ÿæˆä»ªè¡¨ç›˜</p>
          </div>

          <div>
             <div class="flex justify-between items-center mb-1">
                <label for="subscriptionMode" class="block text-sm font-medium text-gray-700">è®¢é˜…æ¨¡å¼</label>
             </div>
            <select id="subscriptionMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white h-10">
              <option value="cycle" selected>ğŸ“… å¾ªç¯è®¢é˜…</option>
              <option value="reset">â³ åˆ°æœŸé‡ç½®</option>
            </select>
            
            <div class="mt-2 flex items-center space-x-3">
                 <label class="inline-flex items-center cursor-pointer select-none">
                  <input type="checkbox" id="showLunar" class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-600">æ˜¾ç¤ºå†œå†æ—¥æœŸ</span>
                </label>
                <label class="inline-flex items-center cursor-pointer select-none">
                  <input type="checkbox" id="useLunar" class="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                  <span class="ml-2 text-sm text-gray-600">å†œå†å‘¨æœŸ</span>
                </label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="md:col-span-2">
            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">å¼€å§‹æ—¥æœŸ</label>
            <div class="relative">
              <input type="text" id="startDate"
                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                placeholder="YYYY-MM-DD">
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                <i class="fas fa-calendar text-gray-400"></i>
              </div>
               <div id="startDatePicker" class="custom-date-picker hidden absolute top-full left-0 z-50 bg-white border border-gray-300 rounded-md shadow-lg p-4 w-full">
                  <div class="flex justify-between items-center mb-4">
                    <button type="button" id="startDatePrevMonth" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-left"></i></button>
                    <div class="flex items-center space-x-2">
                      <span id="startDateMonth" class="font-medium text-gray-900 cursor-pointer hover:text-indigo-600">1æœˆ</span>
                      <span class="text-gray-400">|</span>
                      <span id="startDateYear" class="font-medium text-gray-900 cursor-pointer hover:text-indigo-600">2024</span>
                    </div>
                    <button type="button" id="startDateNextMonth" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-right"></i></button>
                  </div>
                  <div id="startDateMonthPicker" class="hidden mb-4"><div class="flex justify-between items-center mb-3"><span class="font-medium text-gray-900">é€‰æ‹©æœˆä»½</span><button type="button" id="startDateBackToCalendar" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-3 gap-2"><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="0">1æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="1">2æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="2">3æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="3">4æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="4">5æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="5">6æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="6">7æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="7">8æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="8">9æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="9">10æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="10">11æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="11">12æœˆ</button></div></div>
                  <div id="startDateYearPicker" class="hidden mb-4"><div class="flex justify-between items-center mb-3"><span class="font-medium text-gray-900">é€‰æ‹©å¹´ä»½</span><button type="button" id="startDateBackToCalendarFromYear" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times"></i></button></div><div class="flex justify-between items-center mb-3"><button type="button"  id="startDatePrevYearDecade" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-left"></i></button><span id="startDateYearRange" class="font-medium text-gray-900">2020-2029</span><button type="button"  id="startDateNextYearDecade" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-right"></i></button></div><div id="startDateYearGrid" class="grid grid-cols-3 gap-2"></div></div>
                  <div class="grid grid-cols-7 gap-2 mb-3"><div class="text-center text-sm font-semibold text-gray-600 py-2">æ—¥</div><div class="text-center text-sm font-semibold text-gray-600 py-2">ä¸€</div><div class="text-center text-sm font-semibold text-gray-600 py-2">äºŒ</div><div class="text-center text-sm font-semibold text-gray-600 py-2">ä¸‰</div><div class="text-center text-sm font-semibold text-gray-600 py-2">å››</div><div class="text-center text-sm font-semibold text-gray-600 py-2">äº”</div><div class="text-center text-sm font-semibold text-gray-600 py-2">å…­</div></div><div id="startDateCalendar" class="grid grid-cols-7 gap-2"></div>
                  <div class="mt-4 pt-3 border-t border-gray-200"><button type="button" id="startDateGoToToday" class="w-full px-3 py-2 text-sm text-indigo-600 hover:bg-indigo-50 rounded-md"><i class="fas fa-calendar-day mr-2"></i>å›åˆ°ä»Šå¤©</button></div>
               </div>
            </div>
            <div id="startDateLunar" class="lunar-display pl-1"></div>
          </div>
          
          <div>
            <label for="periodValue" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸæ•°å€¼ *</label>
            <input type="number" id="periodValue" min="1" value="1" required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
          </div>
          
          <div>
            <label for="periodUnit" class="block text-sm font-medium text-gray-700 mb-1">å‘¨æœŸå•ä½ *</label>
            <select id="periodUnit" required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
              <option value="day">å¤©</option>
              <option value="month" selected>æœˆ</option>
              <option value="year">å¹´</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
              <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥æœŸ *</label>
              <div class="relative">
                <input type="text" id="expiryDate" required
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                  placeholder="YYYY-MM-DD">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <i class="fas fa-calendar text-gray-400"></i>
                </div>
                <div id="expiryDatePicker" class="custom-date-picker hidden absolute top-full left-0 z-50 bg-white border border-gray-300 rounded-md shadow-lg p-4 w-full">
                    <div class="flex justify-between items-center mb-4">
                      <button type="button" id="expiryDatePrevMonth" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-left"></i></button>
                      <div class="flex items-center space-x-2"><span id="expiryDateMonth" class="font-medium text-gray-900 cursor-pointer hover:text-indigo-600">1æœˆ</span><span class="text-gray-400">|</span><span id="expiryDateYear" class="font-medium text-gray-900 cursor-pointer hover:text-indigo-600">2024</span></div>
                      <button type="button" id="expiryDateNextMonth" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="expiryDateMonthPicker" class="hidden mb-4"><div class="flex justify-between items-center mb-3"><span class="font-medium text-gray-900">é€‰æ‹©æœˆä»½</span><button type="button" id="expiryDateBackToCalendar" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times"></i></button></div><div class="grid grid-cols-3 gap-2"><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="0">1æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="1">2æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="2">3æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="3">4æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="4">5æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="5">6æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="6">7æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="7">8æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="8">9æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="9">10æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="10">11æœˆ</button><button type="button" class="month-option px-3 py-2 text-sm rounded hover:bg-gray-100" data-month="11">12æœˆ</button></div></div>
                    <div id="expiryDateYearPicker" class="hidden mb-4"><div class="flex justify-between items-center mb-3"><span class="font-medium text-gray-900">é€‰æ‹©å¹´ä»½</span><button type="button" id="expiryDateBackToCalendarFromYear" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times"></i></button></div><div class="flex justify-between items-center mb-3"><button type="button" id="expiryDatePrevYearDecade" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-left"></i></button><span id="expiryDateYearRange" class="font-medium text-gray-900">2020-2029</span><button type="button" id="expiryDateNextYearDecade" class="text-gray-600 hover:text-gray-800"><i class="fas fa-chevron-right"></i></button></div><div id="expiryDateYearGrid" class="grid grid-cols-3 gap-2"></div></div>
                    <div class="grid grid-cols-7 gap-2 mb-3"><div class="text-center text-sm font-semibold text-gray-600 py-2">æ—¥</div><div class="text-center text-sm font-semibold text-gray-600 py-2">ä¸€</div><div class="text-center text-sm font-semibold text-gray-600 py-2">äºŒ</div><div class="text-center text-sm font-semibold text-gray-600 py-2">ä¸‰</div><div class="text-center text-sm font-semibold text-gray-600 py-2">å››</div><div class="text-center text-sm font-semibold text-gray-600 py-2">äº”</div><div class="text-center text-sm font-semibold text-gray-600 py-2">å…­</div></div><div id="expiryDateCalendar" class="grid grid-cols-7 gap-2"></div>
                    <div class="mt-4 pt-3 border-t border-gray-200"><button type="button" id="expiryDateGoToToday" class="w-full px-3 py-2 text-sm text-indigo-600 hover:bg-indigo-50 rounded-md"><i class="fas fa-calendar-day mr-2"></i>å›åˆ°ä»Šå¤©</button></div>
                </div>
              </div>
              <div id="expiryDateLunar" class="lunar-display pl-1 mb-1"></div>
              <div class="error-message text-red-500" data-for="expiryDate"></div>
          </div>

          <div class="flex items-start">
              <button type="button" id="calculateExpiryBtn" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md shadow-sm text-sm font-medium transition-colors flex items-center justify-center h-[42px] whitespace-nowrap">
                <i class="fas fa-calculator mr-2"></i>è‡ªåŠ¨è®¡ç®—åˆ°æœŸæ—¥æœŸ
              </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="reminderValue" class="block text-sm font-medium text-gray-700 mb-1">æé†’æå‰é‡</label>
              <div class="flex space-x-2">
                <div class="relative flex-1">
                  <input type="number" id="reminderValue" min="0" value="7"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                </div>
                <div class="w-24 shrink-0">
                  <select id="reminderUnit"
                    class="w-full px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                    <option value="day" selected>å¤©</option>
                    <option value="hour">å°æ—¶</option>
                  </select>
                </div>
              </div>
               <div class="error-message text-red-500" data-for="reminderValue"></div>
               <p id="reminderHint" class="mt-2 text-xs text-gray-500 leading-tight">
                 0 = ä»…åœ¨åˆ°æœŸæ—¶æé†’; é€‰æ‹©"å°æ—¶"éœ€è¦å°† Worker å®šæ—¶ä»»åŠ¡è°ƒæ•´ä¸ºå°æ—¶çº§æ‰§è¡Œ
               </p>
            </div>

            <div>
               <label class="block text-sm font-medium text-gray-700 mb-3">é€‰é¡¹è®¾ç½®</label>
               <div class="flex items-center space-x-6">
                  <label class="inline-flex items-center cursor-pointer select-none group">
                    <input type="checkbox" id="isActive" checked 
                      class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    <span class="ml-2 text-sm text-gray-700 font-medium group-hover:text-indigo-700">å¯ç”¨è®¢é˜…</span>
                  </label>
                  
                  <label class="inline-flex items-center cursor-pointer select-none group">
                    <input type="checkbox" id="autoRenew" checked 
                      class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    <span class="ml-2 text-sm text-gray-700 font-medium group-hover:text-indigo-700">è‡ªåŠ¨ç»­è®¢</span>
                  </label>
               </div>
            </div>
        </div>

        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
          <textarea id="notes" rows="2" placeholder="å¯æ·»åŠ ç›¸å…³å¤‡æ³¨ä¿¡æ¯..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
          <div class="error-message text-red-500"></div>
        </div>
        
        <input type="hidden" id="subscriptionId">

        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
          <button type="button" id="cancelBtn" 
            class="px-5 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 bg-white transition-colors">
            å–æ¶ˆ
          </button>
          <button type="submit" 
            class="btn-primary text-white px-6 py-2 rounded-md text-sm font-medium shadow-md hover:shadow-lg transform active:scale-95 transition-all">
            <i class="fas fa-save mr-2"></i>ä¿å­˜
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // å†œå†è½¬æ¢å·¥å…·å‡½æ•° - å‰ç«¯ç‰ˆæœ¬
    const lunarCalendar = {
      // å†œå†æ•°æ® (1900-2100å¹´)
      lunarInfo: [
        0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2, // 1900-1909
        0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977, // 1910-1919
        0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970, // 1920-1929
        0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950, // 1930-1939
        0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557, // 1940-1949
        0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0, // 1950-1959
        0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0, // 1960-1969
        0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6, // 1970-1979
        0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, // 1980-1989
        0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, // 1990-1999
        0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5, // 2000-2009
        0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, // 2010-2019
        0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, // 2020-2029
        0x05aa0, 0x076a3, 0x096d0, 0x04afb, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, // 2030-2039
        0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0, // 2040-2049
        0x14b63, 0x09370, 0x14a38, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x1a978, 0x16aa0, 0x0a6c0, // 2050-2059 (ä¿®æ­£2057: 0x1a978)
        0x0aa60, 0x16d63, 0x0d260, 0x0d950, 0x0d554, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, // 2060-2069
        0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, // 2070-2079
        0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, // 2080-2089
        0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04afb, 0x1a4bb, 0x0a4d0, 0x0d0b0, // 2090-2099 (ä¿®æ­£2099: 0x0d0b0)
        0x0d250 // 2100
      ],

      // å¤©å¹²åœ°æ”¯
      gan: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'],
      zhi: ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'],

      // å†œå†æœˆä»½
      months: ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'],

      // å†œå†æ—¥æœŸ
      days: ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
             'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
             'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'],

      // è·å–å†œå†å¹´å¤©æ•°
      lunarYearDays: function(year) {
        let sum = 348;
        for (let i = 0x8000; i > 0x8; i >>= 1) {
          sum += (this.lunarInfo[year - 1900] & i) ? 1 : 0;
        }
        return sum + this.leapDays(year);
      },

      // è·å–é—°æœˆå¤©æ•°
      leapDays: function(year) {
        if (this.leapMonth(year)) {
          return (this.lunarInfo[year - 1900] & 0x10000) ? 30 : 29;
        }
        return 0;
      },

      // è·å–é—°æœˆæœˆä»½
      leapMonth: function(year) {
        return this.lunarInfo[year - 1900] & 0xf;
      },

      // è·å–å†œå†æœˆå¤©æ•°
      monthDays: function(year, month) {
        return (this.lunarInfo[year - 1900] & (0x10000 >> month)) ? 30 : 29;
      },

      // å…¬å†è½¬å†œå†
      solar2lunar: function(year, month, day) {
        if (year < 1900 || year > 2100) return null;

        const baseDate = Date.UTC(1900, 0, 31);
        const objDate = Date.UTC(year, month - 1, day);
        //let offset = Math.floor((objDate - baseDate) / 86400000);
        let offset = Math.round((objDate - baseDate) / 86400000);


        let temp = 0;
        let lunarYear = 1900;

        for (lunarYear = 1900; lunarYear < 2101 && offset > 0; lunarYear++) {
          temp = this.lunarYearDays(lunarYear);
          offset -= temp;
        }

        if (offset < 0) {
          offset += temp;
          lunarYear--;
        }

        let lunarMonth = 1;
        let leap = this.leapMonth(lunarYear);
        let isLeap = false;

        for (lunarMonth = 1; lunarMonth < 13 && offset > 0; lunarMonth++) {
          if (leap > 0 && lunarMonth === (leap + 1) && !isLeap) {
            --lunarMonth;
            isLeap = true;
            temp = this.leapDays(lunarYear);
          } else {
            temp = this.monthDays(lunarYear, lunarMonth);
          }

          if (isLeap && lunarMonth === (leap + 1)) isLeap = false;
          offset -= temp;
        }

        if (offset === 0 && leap > 0 && lunarMonth === leap + 1) {
          if (isLeap) {
            isLeap = false;
          } else {
            isLeap = true;
            --lunarMonth;
          }
        }

        if (offset < 0) {
          offset += temp;
          --lunarMonth;
        }

        const lunarDay = offset + 1;

        // ç”Ÿæˆå†œå†å­—ç¬¦ä¸²
        const ganIndex = (lunarYear - 4) % 10;
        const zhiIndex = (lunarYear - 4) % 12;
        const yearStr = this.gan[ganIndex] + this.zhi[zhiIndex] + 'å¹´';
        const monthStr = (isLeap ? 'é—°' : '') + this.months[lunarMonth - 1] + 'æœˆ';
        const dayStr = this.days[lunarDay - 1];

        return {
          year: lunarYear,
          month: lunarMonth,
          day: lunarDay,
          isLeap: isLeap,
          yearStr: yearStr,
          monthStr: monthStr,
          dayStr: dayStr,
          fullStr: yearStr + monthStr + dayStr
        };
      }
    };
	

// æ–°å¢ä¿®æ”¹ï¼Œå†œå†è½¬å…¬å†ï¼ˆç®€åŒ–ï¼Œé€‚ç”¨1900-2100å¹´ï¼‰
function lunar2solar(lunar) {
  for (let y = lunar.year - 1; y <= lunar.year + 1; y++) {
    for (let m = 1; m <= 12; m++) {
      for (let d = 1; d <= 31; d++) {
        const date = new Date(y, m - 1, d);
        if (date.getFullYear() !== y || date.getMonth() + 1 !== m || date.getDate() !== d) continue;
        const l = lunarCalendar.solar2lunar(y, m, d);
        if (
          l &&
          l.year === lunar.year &&
          l.month === lunar.month &&
          l.day === lunar.day &&
          l.isLeap === lunar.isLeap
        ) {
          return { year: y, month: m, day: d };
        }
      }
    }
  }
  return null;
}

// æ–°å¢ä¿®æ”¹ï¼Œå†œå†åŠ å‘¨æœŸï¼Œå‰æœŸç‰ˆæœ¬
function addLunarPeriod(lunar, periodValue, periodUnit) {
  let { year, month, day, isLeap } = lunar;
  if (periodUnit === 'year') {
    year += periodValue;
    const leap = lunarCalendar.leapMonth(year);
    if (isLeap && leap === month) {
      isLeap = true;
    } else {
      isLeap = false;
    }
  } else if (periodUnit === 'month') {
    let totalMonths = (year - 1900) * 12 + (month - 1) + periodValue;
    year = Math.floor(totalMonths / 12) + 1900;
    month = (totalMonths % 12) + 1;
    const leap = lunarCalendar.leapMonth(year);
    if (isLeap && leap === month) {
      isLeap = true;
    } else {
      isLeap = false;
    }
  } else if (periodUnit === 'day') {
    const solar = lunar2solar(lunar);
    const date = new Date(solar.year, solar.month - 1, solar.day + periodValue);
    return lunarCalendar.solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
  }
  let maxDay = isLeap
    ? lunarCalendar.leapDays(year)
    : lunarCalendar.monthDays(year, month);
  let targetDay = Math.min(day, maxDay);
  while (targetDay > 0) {
    let solar = lunar2solar({ year, month, day: targetDay, isLeap });
    if (solar) {
      return { year, month, day: targetDay, isLeap };
    }
    targetDay--;
  }
  return { year, month, day, isLeap };
}

// å‰ç«¯ç‰ˆæœ¬çš„ lunarBiz å¯¹è±¡
const lunarBiz = {
  // å†œå†åŠ å‘¨æœŸï¼Œè¿”å›æ–°çš„å†œå†æ—¥æœŸå¯¹è±¡
  addLunarPeriod(lunar, periodValue, periodUnit) {
    return addLunarPeriod(lunar, periodValue, periodUnit);
  },
  // å†œå†è½¬å…¬å†ï¼ˆéå†æ³•ï¼Œé€‚ç”¨1900-2100å¹´ï¼‰
  lunar2solar(lunar) {
    return lunar2solar(lunar);
  },
  // è·ç¦»å†œå†æ—¥æœŸè¿˜æœ‰å¤šå°‘å¤©
  daysToLunar(lunar) {
    const solar = lunarBiz.lunar2solar(lunar);
    const date = new Date(solar.year, solar.month - 1, solar.day);
    const now = new Date();
    return Math.ceil((date - now) / (1000 * 60 * 60 * 24));
  }
};

    // å†œå†æ˜¾ç¤ºç›¸å…³å‡½æ•°
    function updateLunarDisplay(dateInputId, lunarDisplayId) {
      const dateInput = document.getElementById(dateInputId);
      const lunarDisplay = document.getElementById(lunarDisplayId);
      const showLunar = document.getElementById('showLunar');

      if (!dateInput || !lunarDisplay) {
        return;
      }

      if (!dateInput.value || !showLunar || !showLunar.checked) {
        lunarDisplay.classList.remove('show');
        return;
      }

      // ã€ä¿®å¤ã€‘ç›´æ¥è§£æå­—ç¬¦ä¸² "YYYY-MM-DD"ï¼Œé¿å… new Date() å¸¦æ¥çš„æ—¶åŒºåç§»å¯¼è‡´æ—¥æœŸå°‘ä¸€å¤©
      const parts = dateInput.value.split('-');
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);
      
      const lunar = lunarCalendar.solar2lunar(year, month, day);

      if (lunar) {
        lunarDisplay.textContent = 'å†œå†ï¼š' + lunar.fullStr;
        lunarDisplay.classList.add('show');
      } else {
        lunarDisplay.classList.remove('show');
      }
    }

    function toggleLunarDisplay() {
      const showLunar = document.getElementById('showLunar');
      if (!showLunar) {
        return;
      }
      
      updateLunarDisplay('startDate', 'startDateLunar');
      updateLunarDisplay('expiryDate', 'expiryDateLunar');

      // ä¿å­˜ç”¨æˆ·åå¥½
      localStorage.setItem('showLunar', showLunar.checked);
    }

    function loadLunarPreference() {
      const showLunar = document.getElementById('showLunar');
      if (!showLunar) {
        return;
      }
      
      const saved = localStorage.getItem('showLunar');
      if (saved !== null) {
        showLunar.checked = saved === 'true';
      } else {
        showLunar.checked = true; // é»˜è®¤æ˜¾ç¤º
      }
      toggleLunarDisplay();
    }

    function handleListLunarToggle() {
      const listShowLunar = document.getElementById('listShowLunar');
      // ä¿å­˜ç”¨æˆ·åå¥½
      localStorage.setItem('showLunar', listShowLunar.checked);
      // é‡æ–°åŠ è½½è®¢é˜…åˆ—è¡¨ä»¥åº”ç”¨å†œå†æ˜¾ç¤ºè®¾ç½®
      renderSubscriptionTable();
    }

    function showToast(message, type = 'success', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      
      const icon = type === 'success' ? 'check-circle' :
                   type === 'error' ? 'exclamation-circle' :
                   type === 'warning' ? 'exclamation-triangle' : 'info-circle';
      
      toast.innerHTML = '<div class="flex items-center"><i class="fas fa-' + icon + ' mr-2"></i><span>' + message + '</span></div>';
      
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      let errorDiv = field.parentElement ? field.parentElement.querySelector('.error-message') : null;
      if (!errorDiv) {
        errorDiv = document.querySelector('.error-message[data-for="' + fieldId + '"]');
      }
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.add('show');
        field.classList.add('border-red-500');
      }
    }

    function clearFieldErrors() {
      document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
      });
      document.querySelectorAll('.border-red-500').forEach(el => {
        el.classList.remove('border-red-500');
      });
    }

    function normalizeDateString(value) {
      if (!value) return '';
      const raw = String(value).trim();
      if (!raw) return '';

      const directMatch = raw.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (directMatch) {
        const year = Number(directMatch[1]);
        const month = Number(directMatch[2]);
        const day = Number(directMatch[3]);
        const parsed = new Date(year, month - 1, day);
        if (!isNaN(parsed.getTime()) && parsed.getFullYear() === year && parsed.getMonth() === month - 1 && parsed.getDate() === day) {
          return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
      }

      const parsed = new Date(raw);
      if (!isNaN(parsed.getTime())) {
        return `${parsed.getFullYear()}-${String(parsed.getMonth() + 1).padStart(2, '0')}-${String(parsed.getDate()).padStart(2, '0')}`;
      }

      return '';
    }

    function validateForm() {
      clearFieldErrors();
      let isValid = true;

      const name = document.getElementById('name').value.trim();
      if (!name) {
        showFieldError('name', 'è¯·è¾“å…¥è®¢é˜…åç§°');
        isValid = false;
      }

      const periodValue = document.getElementById('periodValue').value;
      if (!periodValue || periodValue < 1) {
        showFieldError('periodValue', 'å‘¨æœŸæ•°å€¼å¿…é¡»å¤§äº0');
        isValid = false;
      }

      const startDateField = document.getElementById('startDate');
      const expiryDateField = document.getElementById('expiryDate');

      if (startDateField) {
        const normalizedStart = normalizeDateString(startDateField.value);
        if (startDateField.value && !normalizedStart) {
          showFieldError('startDate', 'å¼€å§‹æ—¥æœŸæ ¼å¼éœ€ä¸º YYYY-MM-DD');
          isValid = false;
        } else if (normalizedStart) {
          startDateField.value = normalizedStart;
        }
      }

      const normalizedExpiry = normalizeDateString(expiryDateField ? expiryDateField.value : '');
      if (!normalizedExpiry) {
        showFieldError('expiryDate', 'åˆ°æœŸæ—¥æœŸæ ¼å¼éœ€ä¸º YYYY-MM-DD');
        isValid = false;
      } else if (expiryDateField) {
        expiryDateField.value = normalizedExpiry;
      }

      const reminderValueField = document.getElementById('reminderValue');
      const reminderValue = reminderValueField.value;
      if (reminderValue === '' || Number(reminderValue) < 0) {
        showFieldError('reminderValue', 'æé†’å€¼ä¸èƒ½ä¸ºè´Ÿæ•°');
        isValid = false;
      }

      return isValid;
    }

    // åˆ›å»ºå¸¦æ‚¬æµ®æç¤ºçš„æ–‡æœ¬å…ƒç´ 
    function createHoverText(text, maxLength = 30, className = 'text-sm text-gray-900') {
      if (!text || text.length <= maxLength) {
        return '<div class="' + className + '">' + text + '</div>';
      }

      const truncated = text.substring(0, maxLength) + '...';
      return '<div class="hover-container">' +
        '<div class="hover-text ' + className + '" data-full-text="' + text.replace(/"/g, '&quot;') + '">' +
          truncated +
        '</div>' +
        '<div class="hover-tooltip"></div>' +
      '</div>';
    }

    const categorySeparator = /[\/,ï¼Œ\s]+/;
    let subscriptionsCache = [];
    let searchDebounceTimer = null;

    function normalizeCategoryTokens(category = '') {
      return category
        .split(categorySeparator)
        .map(token => token.trim())
        .filter(token => token.length > 0);
    }

    function populateCategoryFilter(subscriptions) {
      const select = document.getElementById('categoryFilter');
      if (!select) {
        return;
      }

      const previousValue = select.value;
      const categories = new Set();

      (subscriptions || []).forEach(subscription => {
        normalizeCategoryTokens(subscription.category).forEach(token => categories.add(token));
      });

      const sorted = Array.from(categories).sort((a, b) => a.localeCompare(b, 'zh-CN'));
      select.innerHTML = '';

      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'å…¨éƒ¨åˆ†ç±»';
      select.appendChild(defaultOption);

      sorted.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });

      if (previousValue && sorted.map(item => item.toLowerCase()).includes(previousValue.toLowerCase())) {
        select.value = previousValue;
      } else {
        select.value = '';
      }
    }

    function getReminderSettings(subscription) {
      const fallbackDays = subscription.reminderDays !== undefined ? subscription.reminderDays : 7;
      let unit = subscription.reminderUnit || '';
      let value = subscription.reminderValue;

      if (unit !== 'hour') {
        unit = 'day';
      }

      if (unit === 'hour' && (value === undefined || value === null || isNaN(value))) {
        value = subscription.reminderHours !== undefined ? subscription.reminderHours : 0;
      }

      if (value === undefined || value === null || isNaN(value)) {
        value = fallbackDays;
      }

      value = Number(value);

      return {
        unit,
        value,
        displayText: unit === 'hour' ? 'æå‰' + value + 'å°æ—¶' : 'æå‰' + value + 'å¤©'
      };
    }

    function attachHoverListeners() {
      function positionTooltip(element, tooltip) {
        const rect = element.getBoundingClientRect();
        const tooltipHeight = 100;
        const viewportHeight = window.innerHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        let top = rect.bottom + scrollTop + 8;
        let left = rect.left;

        if (rect.bottom + tooltipHeight > viewportHeight) {
          top = rect.top + scrollTop - tooltipHeight - 8;
          tooltip.style.transform = 'translateY(10px)';
          tooltip.classList.add('tooltip-above');
        } else {
          tooltip.style.transform = 'translateY(-10px)';
          tooltip.classList.remove('tooltip-above');
        }

        const maxLeft = window.innerWidth - 320 - 20;
        if (left > maxLeft) {
          left = maxLeft;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
      }

      document.querySelectorAll('.notes-text').forEach(notesElement => {
        const fullNotes = notesElement.getAttribute('data-full-notes');
        const tooltip = notesElement.parentElement.querySelector('.notes-tooltip');

        if (fullNotes && tooltip) {
          notesElement.addEventListener('mouseenter', () => {
            tooltip.textContent = fullNotes;
            positionTooltip(notesElement, tooltip);
            tooltip.classList.add('show');
          });

          notesElement.addEventListener('mouseleave', () => {
            tooltip.classList.remove('show');
          });

          window.addEventListener('scroll', () => {
            if (tooltip.classList.contains('show')) {
              tooltip.classList.remove('show');
            }
          }, { passive: true });
        }
      });

      document.querySelectorAll('.hover-text').forEach(hoverElement => {
        const fullText = hoverElement.getAttribute('data-full-text');
        const tooltip = hoverElement.parentElement.querySelector('.hover-tooltip');

        if (fullText && tooltip) {
          hoverElement.addEventListener('mouseenter', () => {
            tooltip.textContent = fullText;
            positionTooltip(hoverElement, tooltip);
            tooltip.classList.add('show');
          });

          hoverElement.addEventListener('mouseleave', () => {
            tooltip.classList.remove('show');
          });

          window.addEventListener('scroll', () => {
            if (tooltip.classList.contains('show')) {
              tooltip.classList.remove('show');
            }
          }, { passive: true });
        }
      });
    }

    function renderSubscriptionTable() {
      const tbody = document.getElementById('subscriptionsBody');
      if (!tbody) {
        return;
      }

      const listShowLunar = document.getElementById('listShowLunar');
      const showLunar = listShowLunar ? listShowLunar.checked : false;
      const searchInput = document.getElementById('searchKeyword');
      const keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
      const categorySelect = document.getElementById('categoryFilter');
      const selectedCategory = categorySelect ? categorySelect.value.trim().toLowerCase() : '';
      const modeSelect = document.getElementById('modeFilter');
      const selectedMode = modeSelect ? modeSelect.value : '';

      let filtered = Array.isArray(subscriptionsCache) ? [...subscriptionsCache] : [];

      if (selectedCategory) {
        filtered = filtered.filter(subscription =>
          normalizeCategoryTokens(subscription.category).some(token => token.toLowerCase() === selectedCategory)
        );
      }
      
      if (selectedMode) {
        filtered = filtered.filter(subscription => 
          (subscription.subscriptionMode || 'cycle') === selectedMode
        );
      }

      if (keyword) {
        filtered = filtered.filter(subscription => {
          const haystack = [
            subscription.name,
            subscription.customType,
            subscription.notes,
            subscription.category
          ].filter(Boolean).join(' ').toLowerCase();
          return haystack.includes(keyword);
        });
      }

      // æ¸…ç©ºè¡¨æ ¼
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®¢é˜…</td></tr>';
        return;
      }

      filtered.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));

      const currentTime = new Date();
      // å°† Intl å¯¹è±¡å®ä¾‹åŒ–ç§»å‡ºå¾ªç¯ï¼Œé¿å…é‡å¤åˆ›å»ºï¼ˆæå¤§æå‡æ€§èƒ½ï¼‰
      const currentDtf = new Intl.DateTimeFormat('en-US', {
          timeZone: globalTimezone,
          hour12: false,
          year: 'numeric', month: '2-digit', day: '2-digit'
      });
      // è·å–å½“å‰æ—¶åŒºçš„åˆå¤œæ—¶é—´æˆ³ï¼ˆå¤ç”¨ï¼‰
      const currentParts = currentDtf.formatToParts(currentTime);
      const getCurrent = type => Number(currentParts.find(x => x.type === type).value);
      const currentDateInTimezone = Date.UTC(getCurrent('year'), getCurrent('month') - 1, getCurrent('day'), 0, 0, 0);

      const displayDtf = new Intl.DateTimeFormat('zh-CN', {
        timeZone: globalTimezone,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });

      // ä½¿ç”¨ DocumentFragment è¿›è¡Œæ‰¹é‡æ’å…¥ï¼Œå‡å°‘é¡µé¢é‡ç»˜ï¼ˆç§»åŠ¨ç«¯æ€§èƒ½å…³é”®ï¼‰
      const fragment = document.createDocumentFragment();

      filtered.forEach(subscription => {
        const row = document.createElement('tr');
        row.className = subscription.isActive === false ? 'hover:bg-gray-50 bg-gray-100' : 'hover:bg-gray-50';

        const calendarTypeHtml = subscription.useLunar
          ? '<div class="text-xs text-purple-600 mt-1">æ—¥å†ç±»å‹ï¼šå†œå†</div>'
          : '<div class="text-xs text-gray-600 mt-1">æ—¥å†ç±»å‹ï¼šå…¬å†</div>';

        const expiryDate = new Date(subscription.expiryDate);
        
        // è®¡ç®—åˆ°æœŸå¤©æ•°
        const expiryParts = currentDtf.formatToParts(expiryDate);
        const getExpiry = type => Number(expiryParts.find(x => x.type === type).value);
        const expiryDateInTimezone = Date.UTC(getExpiry('year'), getExpiry('month') - 1, getExpiry('day'), 0, 0, 0);

        const daysDiff = Math.round((expiryDateInTimezone - currentDateInTimezone) / (1000 * 60 * 60 * 24));
        const diffMs = expiryDate.getTime() - currentTime.getTime();
        const diffHours = diffMs / (1000 * 60 * 60);

        const reminder = getReminderSettings(subscription);
        const isSoon = reminder.unit === 'hour'
          ? diffHours >= 0 && diffHours <= reminder.value
          : daysDiff >= 0 && daysDiff <= reminder.value;

        let statusHtml = '';
        if (!subscription.isActive) {
          statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-gray-500"><i class="fas fa-pause-circle mr-1"></i>å·²åœç”¨</span>';
        } else if (daysDiff < 0) {
          statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-red-500"><i class="fas fa-exclamation-circle mr-1"></i>å·²è¿‡æœŸ</span>';
        } else if (isSoon) {
          statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-yellow-500"><i class="fas fa-exclamation-triangle mr-1"></i>å³å°†åˆ°æœŸ</span>';
        } else {
          statusHtml = '<span class="px-2 py-1 text-xs font-medium rounded-full text-white bg-green-500"><i class="fas fa-check-circle mr-1"></i>æ­£å¸¸</span>';
        }

        let periodText = '';
        if (subscription.periodValue && subscription.periodUnit) {
          const unitMap = { day: 'å¤©', month: 'æœˆ', year: 'å¹´' };
          periodText = subscription.periodValue + ' ' + (unitMap[subscription.periodUnit] || subscription.periodUnit);
        }

        const autoRenewIcon = subscription.autoRenew !== false
          ? '<i class="fas fa-sync-alt text-blue-500 mr-1" title="è‡ªåŠ¨ç»­è®¢"></i>'
          : '<i class="fas fa-ban text-gray-400 mr-1" title="ä¸è‡ªåŠ¨ç»­è®¢"></i>';

        let lunarExpiryText = '';
        let startLunarText = '';
        
        // å†œå†è®¡ç®—åªåœ¨éœ€è¦æ—¶æ‰§è¡Œï¼Œä¸”ç®€åŒ–é€»è¾‘
        if (showLunar) {
          const getLunarParts = (dateStr) => {
            if (!dateStr) return null;
            const datePart = dateStr.split('T')[0]; 
            const parts = datePart.split('-');
            if (parts.length !== 3) return null;
            return {
              y: parseInt(parts[0], 10),
              m: parseInt(parts[1], 10),
              d: parseInt(parts[2], 10)
            };
          };

          const expiryParts = getLunarParts(subscription.expiryDate);
          if (expiryParts) {
             const lunarExpiry = lunarCalendar.solar2lunar(expiryParts.y, expiryParts.m, expiryParts.d);
             lunarExpiryText = lunarExpiry ? lunarExpiry.fullStr : '';
          }

          if (subscription.startDate) {
            const startParts = getLunarParts(subscription.startDate);
            if (startParts) {
               const lunarStart = lunarCalendar.solar2lunar(startParts.y, startParts.m, startParts.d);
               startLunarText = lunarStart ? lunarStart.fullStr : '';
            }
          }
        }

        let notesHtml = '';
        if (subscription.notes) {
          const notes = subscription.notes;
          if (notes.length > 50) {
            const truncatedNotes = notes.substring(0, 50) + '...';
            notesHtml = '<div class="notes-container">' +
              '<div class="notes-text text-xs text-gray-500" data-full-notes="' + notes.replace(/"/g, '&quot;') + '">' +
                truncatedNotes +
              '</div>' +
              '<div class="notes-tooltip"></div>' +
            '</div>';
          } else {
            notesHtml = '<div class="text-xs text-gray-500">' + notes + '</div>';
          }
        }

        // æ„é€ HTMLå­—ç¬¦ä¸² (å‡å°‘äº†å‡½æ•°è°ƒç”¨)
        const nameHtml = createHoverText(subscription.name, 20, 'text-sm font-medium text-gray-900');
        const typeHtml = createHoverText(subscription.customType || 'å…¶ä»–', 15, 'text-sm text-gray-900');
        const periodHtml = periodText ? createHoverText('å‘¨æœŸ: ' + periodText, 20, 'text-xs text-gray-500 mt-1') : '';
        const modeLabel = (subscription.subscriptionMode === 'reset') ? 'åˆ°æœŸé‡ç½®' : 'å¾ªç¯è®¢é˜…';
        const modeIconClass = (subscription.subscriptionMode === 'reset') ? 'fa-hourglass-end' : 'fa-sync';
        const modeColorClass = (subscription.subscriptionMode === 'reset') ? 'text-orange-500' : 'text-blue-500';
        const modeHtml = '<div class="text-xs ' + modeColorClass + ' mt-1"><i class="fas ' + modeIconClass + ' mr-1"></i>' + modeLabel + '</div>';

        const categoryTokens = normalizeCategoryTokens(subscription.category);
        const categoryHtml = categoryTokens.length
          ? '<div class="flex flex-wrap gap-2 mt-2">' + categoryTokens.map(cat =>
              '<span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-xs rounded-full"><i class="fas fa-tag mr-1"></i>' + cat + '</span>'
            ).join('') + '</div>'
          : '';

        // å¤ç”¨å¤–éƒ¨çš„ format å¯¹è±¡
        const expiryDateText = displayDtf.format(new Date(subscription.expiryDate));
        const lunarHtml = lunarExpiryText ? createHoverText('å†œå†: ' + lunarExpiryText, 25, 'text-xs text-blue-600 mt-1') : '';

        let daysLeftText = '';
        if (diffMs < 0) {
          const absDays = Math.abs(daysDiff);
          if (absDays >= 1) {
            daysLeftText = 'å·²è¿‡æœŸ' + absDays + 'å¤©';
          } else {
            const absHours = Math.ceil(Math.abs(diffHours));
            daysLeftText = 'å·²è¿‡æœŸ' + absHours + 'å°æ—¶';
          }
        } else if (daysDiff >= 1) {
          daysLeftText = 'è¿˜å‰©' + daysDiff + 'å¤©';
        } else {
          const hoursLeft = Math.max(0, Math.ceil(diffHours));
          daysLeftText = hoursLeft > 0 ? 'çº¦ ' + hoursLeft + ' å°æ—¶ååˆ°æœŸ' : 'å³å°†åˆ°æœŸ';
        }

        const startDateText = subscription.startDate
          ? 'å¼€å§‹: ' + displayDtf.format(new Date(subscription.startDate)) + (startLunarText ? ' (' + startLunarText + ')' : '')
          : '';
        const startDateHtml = startDateText ? createHoverText(startDateText, 30, 'text-xs text-gray-500 mt-1') : '';

        const reminderExtra = reminder.value === 0
          ? '<div class="text-xs text-gray-500 mt-1">ä»…åˆ°æœŸæ—¶æé†’</div>'
          : (reminder.unit === 'hour' ? '<div class="text-xs text-gray-500 mt-1">å°æ—¶çº§æé†’</div>' : '');
        const reminderHtml = '<div><i class="fas fa-bell mr-1"></i>' + reminder.displayText + '</div>' + reminderExtra;

        const currencySymbols = {
          'CNY': 'Â¥', 'USD': '$', 'HKD': 'HK$', 'TWD': 'NT$', 
          'JPY': 'Â¥', 'EUR': 'â‚¬', 'GBP': 'Â£', 'KRW': 'â‚©', 'TRY': 'â‚º'
        };
        const currencySymbol = currencySymbols[subscription.currency] || 'Â¥';

        const amountHtml = subscription.amount
          ? '<div class="flex items-center gap-1">' +
              '<span class="text-xs text-gray-500 font-bold">' + currencySymbol + '</span>' +
              '<span class="text-sm font-medium text-gray-900">' + subscription.amount.toFixed(2) + '</span>' +
            '</div>'
          : '<span class="text-xs text-gray-400">æœªè®¾ç½®</span>';

        row.innerHTML =
          '<td data-label="åç§°" class="px-4 py-3"><div class="td-content-wrapper">' +
            nameHtml +
            notesHtml +
          '</div></td>' +
          '<td data-label="ç±»å‹" class="px-4 py-3"><div class="td-content-wrapper space-y-1">' +
            '<div class="flex items-center gap-1">' +
              '<i class="fas fa-layer-group text-gray-400"></i>' +
              typeHtml +
            '</div>' +
            (periodHtml ? '<div class="flex items-center gap-1">' + autoRenewIcon + periodHtml + '</div>' : '') +
            modeHtml +
            categoryHtml +
            calendarTypeHtml +
          '</div></td>' +
          '<td data-label="åˆ°æœŸ" class="px-4 py-3"><div class="td-content-wrapper">' +
            '<div class="text-sm text-gray-900">' + expiryDateText + '</div>' +
            lunarHtml +
            '<div class="text-xs text-gray-500 mt-1">' + daysLeftText + '</div>' +
            startDateHtml +
          '</div></td>' +
          '<td data-label="é‡‘é¢" class="px-4 py-3"><div class="td-content-wrapper">' +
            amountHtml +
          '</div></td>' +
          '<td data-label="æé†’" class="px-4 py-3"><div class="td-content-wrapper">' +
            reminderHtml +
          '</div></td>' +
          '<td data-label="çŠ¶æ€" class="px-4 py-3"><div class="td-content-wrapper">' + statusHtml + '</div></td>' +
          '<td data-label="æ“ä½œ" class="px-4 py-3">' +
            '<div class="action-buttons-wrapper">' +
              '<button class="edit btn-primary text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-edit mr-1"></i>ç¼–è¾‘</button>' +
              '<button class="view-history bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" title="æŸ¥çœ‹æ”¯ä»˜å†å²"><i class="fas fa-history mr-1"></i>å†å²</button>' +
              '<button class="test-notify btn-info text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-paper-plane mr-1"></i>æµ‹è¯•</button>' +
              '<button class="renew-now btn-success text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" title="ç«‹å³ç»­è®¢ä¸€ä¸ªå‘¨æœŸ"><i class="fas fa-sync-alt mr-1"></i>ç»­è®¢</button>' +
              '<button class="delete btn-danger text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '"><i class="fas fa-trash-alt mr-1"></i>åˆ é™¤</button>' +
              (subscription.isActive
                ? '<button class="toggle-status btn-warning text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" data-action="deactivate"><i class="fas fa-pause-circle mr-1"></i>åœç”¨</button>'
                : '<button class="toggle-status btn-success text-white px-2 py-1 rounded text-xs whitespace-nowrap" data-id="' + subscription.id + '" data-action="activate"><i class="fas fa-play-circle mr-1"></i>å¯ç”¨</button>') +
            '</div>' +
          '</td>';

        fragment.appendChild(row);
      });

      tbody.appendChild(fragment);
      document.querySelectorAll('.edit').forEach(button => {
        button.addEventListener('click', editSubscription);
      });

      document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', deleteSubscription);
      });

      document.querySelectorAll('.toggle-status').forEach(button => {
        button.addEventListener('click', toggleSubscriptionStatus);
      });

      document.querySelectorAll('.test-notify').forEach(button => {
        button.addEventListener('click', testSubscriptionNotification);
      });

      document.querySelectorAll('.renew-now').forEach(button => {
        button.addEventListener('click', renewSubscriptionNow);
      });

      document.querySelectorAll('.view-history').forEach(button => {
        button.addEventListener('click', viewPaymentHistory);
      });

      if (window.matchMedia('(hover: hover)').matches) {
          attachHoverListeners();
      }
    }

    const searchInput = document.getElementById('searchKeyword');
    if (searchInput) {
      searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => renderSubscriptionTable(), 200);
      });
    }

    const categorySelect = document.getElementById('categoryFilter');
    if (categorySelect) {
      categorySelect.addEventListener('change', () => renderSubscriptionTable());
    }

    const modeSelect = document.getElementById('modeFilter');
    if (modeSelect) {
      modeSelect.addEventListener('change', () => renderSubscriptionTable());
    }

    // è·å–æ‰€æœ‰è®¢é˜…å¹¶æŒ‰åˆ°æœŸæ—¶é—´æ’åº
    async function loadSubscriptions(showLoading = true) {
      try {
        const listShowLunar = document.getElementById('listShowLunar');
        const saved = localStorage.getItem('showLunar');
        if (listShowLunar) {
          if (saved !== null) {
            listShowLunar.checked = saved === 'true';
          } else {
            listShowLunar.checked = true;
          }
        }

        const tbody = document.getElementById('subscriptionsBody');
        if (tbody && showLoading) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä¸­...</td></tr>';
        }

        const response = await fetch('/api/subscriptions');
        const data = await response.json();

        subscriptionsCache = Array.isArray(data) ? data : [];
        populateCategoryFilter(subscriptionsCache);
        renderSubscriptionTable();
      } catch (error) {
        console.error('åŠ è½½è®¢é˜…å¤±è´¥:', error);
        const tbody = document.getElementById('subscriptionsBody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</td></tr>';
        }
        showToast('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥', 'error');
      }
    }
    
    async function testSubscriptionNotification(e) {
        const button = e.target.closest('button');
        if (!button) {
          showToast('æœªæ‰¾åˆ°æµ‹è¯•æŒ‰é’®ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•', 'error');
          return;
        }

        const id = button.dataset.id;
        if (!id) {
          showToast('è®¢é˜… ID ç¼ºå¤±ï¼Œæ— æ³•å‘é€æµ‹è¯•é€šçŸ¥', 'error');
          return;
        }

        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>å‘é€ä¸­';
        button.disabled = true;

        try {
            const response = await fetch('/api/subscriptions/' + id + '/test-notify', { method: 'POST' });
            let result = null;
            try {
              result = await response.json();
            } catch (_) {
              result = { success: false, message: 'æœåŠ¡è¿”å›äº†æ— æ³•è§£æçš„å“åº”' };
            }

            if (response.ok && result.success) {
                showToast(result.message || 'æµ‹è¯•é€šçŸ¥å‘é€æˆåŠŸ', 'success');
            } else {
                const errorMessage = (result && result.message) ? result.message : ('HTTP ' + response.status);
                showToast('æµ‹è¯•é€šçŸ¥å‘é€å¤±è´¥: ' + errorMessage, 'error', 4500);
            }
        } catch (error) {
            console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
            showToast('å‘é€æµ‹è¯•é€šçŸ¥æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
        } finally {
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }

    async function renewSubscriptionNow(e) {
        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
        const id = button.dataset.id;

        try {
            const response = await fetch('/api/subscriptions/' + id);
            const subscription = await response.json();
            showRenewFormModal(subscription);
        } catch (error) {
            console.error('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥:', error);
            showToast('è·å–è®¢é˜…ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    }

    function showRenewFormModal(subscription) {
        const today = new Date().toISOString().split('T')[0];
        
        // è·å–å½“å‰åˆ°æœŸæ—¥çš„æ˜¾ç¤ºæ–‡æœ¬
        let currentExpiryDisplay = 'æ— ';
        if (subscription.expiryDate) {
            const datePart = subscription.expiryDate.split('T')[0];
            currentExpiryDisplay = datePart;
            if (subscription.useLunar) {
                try {
                    const parts = datePart.split('-');
                    const y = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10);
                    const d = parseInt(parts[2], 10);
                    const lunarObj = lunarCalendar.solar2lunar(y, m, d);
                    if (lunarObj) {
                        currentExpiryDisplay += ' (å†œå†: ' + lunarObj.fullStr + ')';
                    }
                } catch (e) {
                    console.error('å†œå†è®¡ç®—å¤±è´¥', e);
                }
            }
        }

        const defaultAmount = subscription.amount || 0;
        
        // è·å–åŠ¨æ€è´§å¸ç¬¦å·
        const currencySymbols = {
          'CNY': 'Â¥', 'USD': '$', 'HKD': 'HK$', 'TWD': 'NT$', 
          'JPY': 'Â¥', 'EUR': 'â‚¬', 'GBP': 'Â£', 'KRW': 'â‚©', 'TRY': 'â‚º'
        };
        const currency = subscription.currency || 'CNY';
        const symbol = currencySymbols[currency] || 'Â¥';
        const currencyLabel = "(" + currency + " " + symbol + ")";
        
        const lunarBadge = subscription.useLunar ? 
            '<span class="text-sm bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full border border-purple-200 shrink-0">å†œå†å‘¨æœŸ</span>' : '';

        // æ„å»º Modal HTML
        const modalHtml = 
            '<div id="renewFormModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="closeRenewFormModal(event)">' +
            '    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">' +
            '        <div class="flex justify-between items-center pb-3 border-b">' +
            '            <h3 class="text-xl font-semibold text-gray-900">' +
            '                <i class="fas fa-sync-alt mr-2"></i>æ‰‹åŠ¨ç»­è®¢ - ' + subscription.name +
            '            </h3>' +
            '            <button onclick="closeRenewFormModal()" class="text-gray-400 hover:text-gray-500">' +
            '                <i class="fas fa-times text-2xl"></i>' +
            '            </button>' +
            '        </div>' +
            '' +
            '        <form id="renewForm" class="mt-4 space-y-4">' +
            '            <div>' +
            '                <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯ä»˜æ—¥æœŸ</label>' +
            '                <input type="date" id="renewPaymentDate" value="' + today + '"' +
            '                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">' +
            '            </div>' +
            '' +
            '            <div>' +
            '                <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯ä»˜é‡‘é¢ ' + currencyLabel + '</label>' +
            '                <input type="number" id="renewAmount" value="' + defaultAmount + '" step="0.01" min="0"' +
            '                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">' +
            '            </div>' +
            '' +
            '            <div>' +
            '                <div class="flex justify-between items-center mb-1">' +
            '                    <label class="block text-sm font-medium text-gray-700">ç»­è®¢å‘¨æœŸæ•°</label>' +
            '                    ' + lunarBadge + 
            '                </div>' +
            '                <div class="flex items-center space-x-2">' +
            '                    <input type="number" id="renewPeriodMultiplier" value="1" min="1" max="120"' +
            '                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"' +
            '                           oninput="updateNewExpiryPreview()">' +
            '                    <span class="text-gray-600">ä¸ª</span>' + 
            '                </div>' +
            '                <p class="mt-1 text-xs text-gray-500">ä¸€æ¬¡æ€§ç»­è®¢å¤šä¸ªå‘¨æœŸï¼ˆå¦‚12ä¸ªæœˆï¼‰</p>' +
            '            </div>' +
            '' +
            '            <div class="bg-blue-50 rounded-lg p-4 mb-4">' +
            '                <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 mb-3 sm:mb-2">' +
            '                    <span class="text-gray-500 text-sm shrink-0">å½“å‰åˆ°æœŸ:</span>' +
            '                    <span class="font-medium text-gray-900 text-sm break-words">' + currentExpiryDisplay + '</span>' +
            '                </div>' +
            '                <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">' +
            '                    <span class="text-gray-500 text-sm shrink-0">æ–°åˆ°æœŸæ—¥:</span>' +
            '                    <span class="font-medium text-blue-600 text-sm break-words" id="newExpiryPreview">è®¡ç®—ä¸­...</span>' +
            '                </div>' +
            '            </div>' +
            '' +
            '            <div>' +
            '                <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨ (å¯é€‰)</label>' +
            '                <input type="text" id="renewNote" placeholder="ä¾‹å¦‚ï¼šå¹´åº¦ä¼˜æƒ ã€ä»·æ ¼è°ƒæ•´"' +
            '                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">' +
            '            </div>' +
            '' +
            '            <div class="flex justify-end space-x-3 pt-3">' +
            '                <button type="button" onclick="closeRenewFormModal()"' +
            '                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md">' +
            '                    å–æ¶ˆ' +
            '                </button>' +
            '                <button type="submit" id="confirmRenewBtn"' +
            '                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md">' +
            '                    <i class="fas fa-check mr-1"></i>ç¡®è®¤ç»­è®¢' +
            '                </button>' +
            '            </div>' +
            '        </form>' +
            '    </div>' +
            '</div>';

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.getElementById('renewForm').dataset.subscriptionId = subscription.id;
        document.getElementById('renewForm').dataset.subscriptionData = JSON.stringify(subscription);
        updateNewExpiryPreview();
        document.getElementById('renewForm').addEventListener('submit', handleRenewFormSubmit);
        document.getElementById('renewPeriodMultiplier').addEventListener('input', updateNewExpiryPreview);
    }

    function updateNewExpiryPreview() {
        const form = document.getElementById('renewForm');
        if (!form) return;

        const subscription = JSON.parse(form.dataset.subscriptionData);
        const multiplier = parseInt(document.getElementById('renewPeriodMultiplier').value) || 1;

        // è·å–åŸºå‡†æ—¥æœŸï¼Œé¿å…ç›´æ¥ new Date() çš„æ—¶åŒºé—®é¢˜
        const getDateParts = (dateStr) => {
            if (!dateStr) return { year: 2024, month: 1, day: 1 };
            const part = dateStr.split('T')[0];
            const parts = part.split('-');
            return {
                year: parseInt(parts[0], 10),
                month: parseInt(parts[1], 10),
                day: parseInt(parts[2], 10)
            };
        };

        const parts = getDateParts(subscription.expiryDate);
        
        if (subscription.useLunar) {
            try {
                // 1. è½¬ä¸ºå†œå†å¯¹è±¡
                let lunar = lunarCalendar.solar2lunar(parts.year, parts.month, parts.day);
                
                if (lunar) {
                    // 2. å¾ªç¯æ·»åŠ å‘¨æœŸ
                    let nextLunar = lunar;
                    for(let i = 0; i < multiplier; i++) {
                        nextLunar = lunarBiz.addLunarPeriod(nextLunar, subscription.periodValue, subscription.periodUnit);
                    }
                    
                    // 3. è½¬å›å…¬å†
                    const solar = lunarBiz.lunar2solar(nextLunar);
                    
                    // é‡ç‚¹ï¼šç”¨è®¡ç®—å‡ºçš„å…¬å†æ—¥æœŸé‡æ–°è·å–å®Œæ•´çš„å†œå†å¯¹è±¡ï¼Œç¡®ä¿æœ‰ fullStr å±æ€§
                    const fullNextLunar = lunarCalendar.solar2lunar(solar.year, solar.month, solar.day);
                    
                    // æ ¼å¼åŒ–è¾“å‡º YYYY-MM-DD
                    const resultStr = solar.year + '-' + 
                                      String(solar.month).padStart(2, '0') + '-' + 
                                      String(solar.day).padStart(2, '0');
                                      
                    document.getElementById('newExpiryPreview').textContent = resultStr + ' (å†œå†: ' + fullNextLunar.fullStr + ')';
                } else {
                    document.getElementById('newExpiryPreview').textContent = 'æ—¥æœŸè®¡ç®—é”™è¯¯';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('newExpiryPreview').textContent = 'è®¡ç®—å‡ºé”™';
            }
        } else {
            // å…¬å†è®¡ç®—é€»è¾‘
            const tempDate = new Date(parts.year, parts.month - 1, parts.day);
            const totalPeriodValue = subscription.periodValue * multiplier;
            
            if (subscription.periodUnit === 'day') {
                tempDate.setDate(tempDate.getDate() + totalPeriodValue);
            } else if (subscription.periodUnit === 'month') {
                tempDate.setMonth(tempDate.getMonth() + totalPeriodValue);
            } else if (subscription.periodUnit === 'year') {
                tempDate.setFullYear(tempDate.getFullYear() + totalPeriodValue);
            }
            
            // æ ¼å¼åŒ–è¾“å‡º YYYY-MM-DD
            const y = tempDate.getFullYear();
            const m = String(tempDate.getMonth() + 1).padStart(2, '0');
            const d = String(tempDate.getDate()).padStart(2, '0');
            
            document.getElementById('newExpiryPreview').textContent = y + '-' + m + '-' + d;
        }
    }

    async function handleRenewFormSubmit(e) {
        e.preventDefault();

        const form = e.target;
        const subscriptionId = form.dataset.subscriptionId;
        const confirmBtn = document.getElementById('confirmRenewBtn');

        const options = {
            paymentDate: document.getElementById('renewPaymentDate').value,
            amount: parseFloat(document.getElementById('renewAmount').value) || 0,
            periodMultiplier: parseInt(document.getElementById('renewPeriodMultiplier').value) || 1,
            note: document.getElementById('renewNote').value || 'æ‰‹åŠ¨ç»­è®¢'
        };

        const originalBtnContent = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ç»­è®¢ä¸­...';
        confirmBtn.disabled = true;

        try {
            const response = await fetch('/api/subscriptions/' + subscriptionId + '/renew', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(options)
            });
            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'ç»­è®¢æˆåŠŸ', 'success');
                closeRenewFormModal();
                await loadSubscriptions(false);
            } else {
                showToast(result.message || 'ç»­è®¢å¤±è´¥', 'error');
                confirmBtn.innerHTML = originalBtnContent;
                confirmBtn.disabled = false;
            }
        } catch (error) {
            console.error('ç»­è®¢å¤±è´¥:', error);
            showToast('ç»­è®¢æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            confirmBtn.innerHTML = originalBtnContent;
            confirmBtn.disabled = false;
        }
    }

    window.closeRenewFormModal = function(event) {
        if (event && event.target.id !== 'renewFormModal') {
            return;
        }
        const modal = document.getElementById('renewFormModal');
        if (modal) {
            modal.remove();
        }
    };

    async function viewPaymentHistory(e) {
        const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
        const id = button.dataset.id;

        try {
            const response = await fetch('/api/subscriptions/' + id + '/payments');
            const result = await response.json();

            if (!result.success) {
                showToast(result.message || 'è·å–æ”¯ä»˜å†å²å¤±è´¥', 'error');
                return;
            }

            const payments = result.payments || [];
            const subscriptionResponse = await fetch('/api/subscriptions/' + id);
            const subscriptionData = await subscriptionResponse.json();
            const subscription = subscriptionData;

            showPaymentHistoryModal(subscription, payments);
        } catch (error) {
            console.error('è·å–æ”¯ä»˜å†å²å¤±è´¥:', error);
            showToast('è·å–æ”¯ä»˜å†å²æ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    }

    function showPaymentHistoryModal(subscription, payments) {
        const totalAmount = payments.reduce((sum, p) => sum + (p.amount || 0), 0);
        const paymentCount = payments.length;

        let paymentsHtml = '';
        if (payments.length === 0) {
            paymentsHtml = '<div class="text-center text-gray-500 py-8">æš‚æ— æ”¯ä»˜è®°å½•</div>';
        } else {
            paymentsHtml = payments.reverse().map(payment => {
                const typeLabel = payment.type === 'initial' ? 'åˆå§‹è®¢é˜…' :
                                payment.type === 'manual' ? 'æ‰‹åŠ¨ç»­è®¢' :
                                payment.type === 'auto' ? 'è‡ªåŠ¨ç»­è®¢' : 'æœªçŸ¥';
                const typeClass = payment.type === 'initial' ? 'bg-blue-100 text-blue-800' :
                                payment.type === 'manual' ? 'bg-green-100 text-green-800' :
                                payment.type === 'auto' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800';
                const date = new Date(payment.date);
                const formattedDate = date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                const formattedTime = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

                // è®¡è´¹å‘¨æœŸæ ¼å¼åŒ–
                let periodHtml = '';
                if (payment.periodStart && payment.periodEnd) {
                    const periodStart = new Date(payment.periodStart);
                    const periodEnd = new Date(payment.periodEnd);
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    const startStr = periodStart.toLocaleDateString('zh-CN', options);
                    const endStr = periodEnd.toLocaleDateString('zh-CN', options);
                    periodHtml = '<div class="mt-1 ml-6 text-xs text-gray-500"><i class="fas fa-clock mr-1"></i>è®¡è´¹å‘¨æœŸ: ' + startStr + ' - ' + endStr + '</div>';
                }

                const noteHtml = payment.note ? '<div class="mt-1 ml-6 text-sm text-gray-600">' + payment.note + '</div>' : '';
                const paymentDataJson = JSON.stringify(payment).replace(/"/g, '&quot;');
                return `
                    <div class="border-b border-gray-200 py-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start gap-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar-alt text-gray-400"></i>
                                    <span class="font-medium">${formattedDate} ${formattedTime}</span>
                                    <span class="px-2 py-1 rounded text-xs font-medium ${typeClass}">${typeLabel}</span>
                                </div>
                                ${periodHtml}
                                ${noteHtml}
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <div class="text-lg font-bold text-gray-900">Â¥${payment.amount.toFixed(2)}</div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editPaymentRecord('${subscription.id}', '${payment.id}')"
                                            class="text-blue-600 hover:text-blue-800 px-2 py-1"
                                            title="ç¼–è¾‘">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deletePaymentRecord('${subscription.id}', '${payment.id}')"
                                            class="text-red-600 hover:text-red-800 px-2 py-1"
                                            title="åˆ é™¤">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        const modalHtml = `
            <div id="paymentHistoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="closePaymentHistoryModal(event)">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-history mr-2"></i>${subscription.name} - æ”¯ä»˜å†å²
                        </h3>
                        <button onclick="closePaymentHistoryModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <div class="mt-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-sm text-gray-600">ç´¯è®¡æ”¯å‡º</div>
                                <div class="text-2xl font-bold text-purple-600">Â¥${totalAmount.toFixed(2)}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">æ”¯ä»˜æ¬¡æ•°</div>
                                <div class="text-2xl font-bold text-blue-600">${paymentCount}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 max-h-96 overflow-y-auto">
                        ${paymentsHtml}
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button onclick="closePaymentHistoryModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            å…³é—­
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    window.closePaymentHistoryModal = function(event) {
        if (event && event.target.id !== 'paymentHistoryModal') {
            return;
        }
        const modal = document.getElementById('paymentHistoryModal');
        if (modal) {
            modal.remove();
        }
    };

    window.deletePaymentRecord = async function(subscriptionId, paymentId) {
        if (!confirm('ç¡®è®¤åˆ é™¤æ­¤æ”¯ä»˜è®°å½•ï¼Ÿåˆ é™¤åå°†é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®ã€‚')) {
            return;
        }

        try {
            const response = await fetch(`/api/subscriptions/${subscriptionId}/payments/${paymentId}`, {
                method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'æ”¯ä»˜è®°å½•å·²åˆ é™¤', 'success');
                // å…³é—­å½“å‰æ¨¡æ€æ¡†
                closePaymentHistoryModal();
                // åˆ·æ–°è®¢é˜…åˆ—è¡¨
                await loadSubscriptions(false);
            } else {
                showToast(result.message || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (error) {
            console.error('åˆ é™¤æ”¯ä»˜è®°å½•å¤±è´¥:', error);
            showToast('åˆ é™¤æ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    };

    window.editPaymentRecord = async function(subscriptionId, paymentId) {
        try {
            // è·å–è®¢é˜…ä¿¡æ¯
            const subResponse = await fetch(`/api/subscriptions/${subscriptionId}`);
            const subscription = await subResponse.json();

            // è·å–æ”¯ä»˜å†å²
            const payResponse = await fetch(`/api/subscriptions/${subscriptionId}/payments`);
            const payResult = await payResponse.json();

            const payment = payResult.payments.find(p => p.id === paymentId);
            if (!payment) {
                showToast('æ”¯ä»˜è®°å½•ä¸å­˜åœ¨', 'error');
                return;
            }

            showEditPaymentModal(subscription, payment);
        } catch (error) {
            console.error('è·å–æ”¯ä»˜è®°å½•å¤±è´¥:', error);
            showToast('è·å–æ”¯ä»˜è®°å½•æ—¶å‘ç”Ÿé”™è¯¯', 'error');
        }
    };

    function showEditPaymentModal(subscription, payment) {
        const paymentDate = new Date(payment.date);
        const formattedDate = paymentDate.toISOString().split('T')[0];

        const modalHtml = `
            <div id="editPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="closeEditPaymentModal(event)">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h3 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-edit mr-2"></i>ç¼–è¾‘æ”¯ä»˜è®°å½•
                        </h3>
                        <button onclick="closeEditPaymentModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>

                    <form id="editPaymentForm" class="mt-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…åç§°</label>
                            <input type="text" value="${subscription.name}" disabled
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯ä»˜æ—¥æœŸ</label>
                            <input type="date" id="editPaymentDate" value="${formattedDate}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ”¯ä»˜é‡‘é¢ (Â¥)</label>
                            <input type="number" id="editPaymentAmount" value="${payment.amount}" step="0.01" min="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                            <input type="text" id="editPaymentNote" value="${payment.note || ''}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div class="flex justify-end space-x-3 pt-3">
                            <button type="button" onclick="closeEditPaymentModal()"
                                    class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" id="confirmEditBtn"
                                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">
                                <i class="fas fa-check mr-1"></i>ä¿å­˜
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // ä¿å­˜ä¿¡æ¯åˆ°è¡¨å•
        document.getElementById('editPaymentForm').dataset.subscriptionId = subscription.id;
        document.getElementById('editPaymentForm').dataset.paymentId = payment.id;

        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('editPaymentForm').addEventListener('submit', handleEditPaymentSubmit);
    }

    async function handleEditPaymentSubmit(e) {
        e.preventDefault();

        const form = e.target;
        const subscriptionId = form.dataset.subscriptionId;
        const paymentId = form.dataset.paymentId;
        const confirmBtn = document.getElementById('confirmEditBtn');

        const paymentData = {
            date: document.getElementById('editPaymentDate').value,
            amount: parseFloat(document.getElementById('editPaymentAmount').value) || 0,
            note: document.getElementById('editPaymentNote').value
        };

        const originalBtnContent = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>ä¿å­˜ä¸­...';
        confirmBtn.disabled = true;

        try {
            const response = await fetch(`/api/subscriptions/${subscriptionId}/payments/${paymentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentData)
            });
            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'æ”¯ä»˜è®°å½•å·²æ›´æ–°', 'success');
                closeEditPaymentModal();
                closePaymentHistoryModal();
                await loadSubscriptions(false);
            } else {
                showToast(result.message || 'æ›´æ–°å¤±è´¥', 'error');
                confirmBtn.innerHTML = originalBtnContent;
                confirmBtn.disabled = false;
            }
        } catch (error) {
            console.error('æ›´æ–°æ”¯ä»˜è®°å½•å¤±è´¥:', error);
            showToast('æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            confirmBtn.innerHTML = originalBtnContent;
            confirmBtn.disabled = false;
        }
    }

    window.closeEditPaymentModal = function(event) {
        if (event && event.target.id !== 'editPaymentModal') {
            return;
        }
        const modal = document.getElementById('editPaymentModal');
        if (modal) {
            modal.remove();
        }
    };

    async function toggleSubscriptionStatus(e) {
      const id = e.target.dataset.id || e.target.parentElement.dataset.id;
      const action = e.target.dataset.action || e.target.parentElement.dataset.action;
      const isActivate = action === 'activate';
      
      const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (isActivate ? 'å¯ç”¨ä¸­...' : 'åœç”¨ä¸­...');
      button.disabled = true;
      
      try {
        const response = await fetch('/api/subscriptions/' + id + '/toggle-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isActive: isActivate })
        });
        
        if (response.ok) {
          showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'æˆåŠŸ', 'success');
          loadSubscriptions();
        } else {
          const error = await response.json();
          showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      } catch (error) {
        console.error((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'è®¢é˜…å¤±è´¥:', error);
        showToast((isActivate ? 'å¯ç”¨' : 'åœç”¨') + 'å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        button.innerHTML = originalContent;
        button.disabled = false;
      }
    }
    
    document.getElementById('addSubscriptionBtn').addEventListener('click', () => {
      document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°è®¢é˜…';
      document.getElementById('subscriptionModal').classList.remove('hidden');
      document.body.classList.add('overflow-hidden'); // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨

      document.getElementById('subscriptionForm').reset();
      document.getElementById('currency').value = 'CNY'; // é»˜è®¤è®¾ç½®ä¸ºCNY
      document.getElementById('subscriptionId').value = '';
      clearFieldErrors();

      const today = new Date().toISOString().split('T')[0]; // å‰ç«¯ä½¿ç”¨æœ¬åœ°æ—¶é—´
      document.getElementById('startDate').value = today;
      document.getElementById('category').value = '';
      document.getElementById('reminderValue').value = '7';
      document.getElementById('reminderUnit').value = 'day';
      document.getElementById('isActive').checked = true;
      document.getElementById('autoRenew').checked = true;

      loadLunarPreference();
      calculateExpiryDate();
      setupModalEventListeners();
    });

    // è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨åŠŸèƒ½
    class CustomDatePicker {
      constructor(inputId, pickerId, calendarId, monthId, yearId, prevBtnId, nextBtnId) {
        console.log('CustomDatePicker æ„é€ å‡½æ•°:', { inputId, pickerId, calendarId, monthId, yearId, prevBtnId, nextBtnId });
        
        this.input = document.getElementById(inputId);
        this.picker = document.getElementById(pickerId);
        this.calendar = document.getElementById(calendarId);
        this.monthElement = document.getElementById(monthId);
        this.yearElement = document.getElementById(yearId);
        this.prevBtn = document.getElementById(prevBtnId);
        this.nextBtn = document.getElementById(nextBtnId);
        
        // æ–°å¢å…ƒç´ 
        this.monthPicker = document.getElementById(pickerId.replace('Picker', 'MonthPicker'));
        this.yearPicker = document.getElementById(pickerId.replace('Picker', 'YearPicker'));
        this.backToCalendarBtn = document.getElementById(pickerId.replace('Picker', 'BackToCalendar'));
        this.backToCalendarFromYearBtn = document.getElementById(pickerId.replace('Picker', 'BackToCalendarFromYear'));
        this.goToTodayBtn = document.getElementById(pickerId.replace('Picker', 'GoToToday'));
        this.prevYearDecadeBtn = document.getElementById(pickerId.replace('Picker', 'PrevYearDecade'));
        this.nextYearDecadeBtn = document.getElementById(pickerId.replace('Picker', 'NextYearDecade'));
        this.yearRangeElement = document.getElementById(pickerId.replace('Picker', 'YearRange'));
        this.yearGrid = document.getElementById(pickerId.replace('Picker', 'YearGrid'));
        
        console.log('æ‰¾åˆ°çš„å…ƒç´ :', {
          input: !!this.input,
          picker: !!this.picker,
          calendar: !!this.calendar,
          monthElement: !!this.monthElement,
          yearElement: !!this.yearElement,
          prevBtn: !!this.prevBtn,
          nextBtn: !!this.nextBtn
        });
        
        this.currentDate = new Date();
        this.selectedDate = null;
        this.currentView = 'calendar'; // 'calendar', 'month', 'year'
        this.yearDecade = Math.floor(this.currentDate.getFullYear() / 10) * 10;
        
        this.init();
      }
      
      init() {
        console.log('åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨ï¼Œè¾“å…¥æ¡†:', !!this.input, 'é€‰æ‹©å™¨:', !!this.picker);
        
        // ç»‘å®šåŸºæœ¬äº‹ä»¶
        if (this.input) {
          // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          this.input.removeEventListener('click', this._forceShowHandler);
          this._forceShowHandler = () => this.forceShow();
          this.input.addEventListener('click', this._forceShowHandler);
          if (this._manualInputHandler) {
            this.input.removeEventListener('blur', this._manualInputHandler);
          }
          this._manualInputHandler = () => this.syncFromInputValue();
          this.input.addEventListener('blur', this._manualInputHandler);

          if (this._manualKeydownHandler) {
            this.input.removeEventListener('keydown', this._manualKeydownHandler);
          }
          this._manualKeydownHandler = (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              this.syncFromInputValue();
            }
          };
          this.input.addEventListener('keydown', this._manualKeydownHandler);
        }
        
        if (this.prevBtn) {
          this.prevBtn.removeEventListener('click', this._prevHandler);
          this._prevHandler = () => this.previousMonth();
          this.prevBtn.addEventListener('click', this._prevHandler);
        }
        
        if (this.nextBtn) {
          this.nextBtn.removeEventListener('click', this._nextHandler);
          this._nextHandler = () => this.nextMonth();
          this.nextBtn.addEventListener('click', this._nextHandler);
        }
        
        // ç»‘å®šæœˆä»½å’Œå¹´ä»½ç‚¹å‡»äº‹ä»¶
        if (this.monthElement) {
          this.monthElement.removeEventListener('click', this._showMonthHandler);
          this._showMonthHandler = () => this.showMonthPicker();
          this.monthElement.addEventListener('click', this._showMonthHandler);
        }
        
        if (this.yearElement) {
          this.yearElement.removeEventListener('click', this._showYearHandler);
          this._showYearHandler = () => this.showYearPicker();
          this.yearElement.addEventListener('click', this._showYearHandler);
        }
        
        // ç»‘å®šæœˆä»½é€‰æ‹©å™¨äº‹ä»¶
        if (this.monthPicker) {
          this.monthPicker.removeEventListener('click', this._monthSelectHandler);
          this._monthSelectHandler = (e) => {
            if (e.target.classList.contains('month-option')) {
              const month = parseInt(e.target.dataset.month);
              this.selectMonth(month);
            }
          };
          this.monthPicker.addEventListener('click', this._monthSelectHandler);
        }
        
        if (this.backToCalendarBtn) {
          this.backToCalendarBtn.removeEventListener('click', this._backToCalendarHandler);
          this._backToCalendarHandler = () => this.showCalendar();
          this.backToCalendarBtn.addEventListener('click', this._backToCalendarHandler);
        }
        
        if (this.backToCalendarFromYearBtn) {
          this.backToCalendarFromYearBtn.removeEventListener('click', this._backToCalendarFromYearHandler);
          this._backToCalendarFromYearHandler = () => this.showCalendar();
          this.backToCalendarFromYearBtn.addEventListener('click', this._backToCalendarFromYearHandler);
        }
        
        // ç»‘å®šå¹´ä»½é€‰æ‹©å™¨äº‹ä»¶
        if (this.prevYearDecadeBtn) {
        this.prevYearDecadeBtn.removeEventListener('click', this._prevYearDecadeHandler);
        this._prevYearDecadeHandler = (e) => {
            e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°è¡¨å•
            this.previousYearDecade();
        };
        this.prevYearDecadeBtn.addEventListener('click', this._prevYearDecadeHandler);
        }

        if (this.nextYearDecadeBtn) {
        this.nextYearDecadeBtn.removeEventListener('click', this._nextYearDecadeHandler);
        this._nextYearDecadeHandler = (e) => {
            e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ°è¡¨å•
            this.nextYearDecade();
        };
        this.nextYearDecadeBtn.addEventListener('click', this._nextYearDecadeHandler);
}
        
        // ç»‘å®šå›åˆ°ä»Šå¤©äº‹ä»¶
        if (this.goToTodayBtn) {
          this.goToTodayBtn.removeEventListener('click', this._goToTodayHandler);
          this._goToTodayHandler = () => this.goToToday();
          this.goToTodayBtn.addEventListener('click', this._goToTodayHandler);
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        if (this._outsideClickHandler) {
          document.removeEventListener('click', this._outsideClickHandler);
        }
        this._outsideClickHandler = (e) => {
          if (this.picker && !this.picker.contains(e.target) && !this.input.contains(e.target)) {
            console.log('ç‚¹å‡»å¤–éƒ¨ï¼Œéšè—æ—¥æœŸé€‰æ‹©å™¨');
            this.hide();
          }
        };
        document.addEventListener('click', this._outsideClickHandler);
        
        // åˆå§‹åŒ–æ˜¾ç¤ºï¼ˆé™é»˜ï¼Œé¿å…ç¼–è¾‘å¼¹çª—åˆå§‹åŒ–æ—¶è¯¯æŠ¥ï¼‰
        this.syncFromInputValue({ silent: true });
        this.render();
        this.renderYearGrid();
      }
      
      toggle() {
        console.log('toggle è¢«è°ƒç”¨');
        console.log('picker å…ƒç´ :', this.picker);
        console.log('picker ç±»å:', this.picker ? this.picker.className : 'null');
        console.log('æ˜¯å¦åŒ…å« hidden:', this.picker ? this.picker.classList.contains('hidden') : 'null');
        
        if (this.picker && this.picker.classList.contains('hidden')) {
          console.log('æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨');
          this.show();
        } else {
          console.log('éšè—æ—¥æœŸé€‰æ‹©å™¨');
          this.hide();
        }
      }
      
      // å¼ºåˆ¶æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
      forceShow() {
        console.log('forceShow è¢«è°ƒç”¨');
        if (this.picker) {
          // ç¡®ä¿é€‰æ‹©å™¨æ˜¾ç¤º
          this.picker.classList.remove('hidden');
          // é‡ç½®åˆ°æ—¥å†è§†å›¾
          this.currentView = 'calendar';
          this.hideAllViews();
          this.render();
          console.log('æ—¥æœŸé€‰æ‹©å™¨å·²æ˜¾ç¤º');
        } else {
          console.error('æ—¥æœŸé€‰æ‹©å™¨å…ƒç´ ä¸å­˜åœ¨');
        }
      }
      
      show() {
        if (this.picker) {
          this.picker.classList.remove('hidden');
          this.render();
        }
      }
      
      hide() {
        if (this.picker) {
          this.picker.classList.add('hidden');
        }
      }
      
      previousMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
        this.render();
      }
      
      nextMonth() {
        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
        this.render();
      }
      
      selectDate(date) {
        this.selectedDate = date;
        if (this.input) {
          // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ ¼å¼åŒ–ï¼Œé¿å…æ—¶åŒºé—®é¢˜
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          this.input.value = year + '-' + month + '-' + day;
        }
        this.hide();
        
        // è§¦å‘changeäº‹ä»¶ï¼Œä½†ä¸å†’æ³¡åˆ°è¡¨å•
        if (this.input) {
          const event = new Event('change', { bubbles: false });
          this.input.dispatchEvent(event);
        }
      }

      syncFromInputValue(options = {}) {
        if (!this.input) {
          return;
        }
        const { silent = false } = options;
        const value = this.input.value.trim();
        if (!value) {
          this.selectedDate = null;
          return;
        }

        const normalized = normalizeDateString(value);
        if (!normalized) {
          if (!silent && typeof showToast === 'function') {
            showToast('æ—¥æœŸæ ¼å¼éœ€ä¸º YYYY-MM-DD', 'warning');
          }
          return;
        }

        const [yearStr, monthStr, dayStr] = normalized.split('-');
        const year = Number(yearStr);
        const month = Number(monthStr);
        const day = Number(dayStr);
        const parsed = new Date(year, month - 1, day);
        if (isNaN(parsed.getTime()) || parsed.getFullYear() !== year || parsed.getMonth() !== month - 1 || parsed.getDate() !== day) {
          if (!silent && typeof showToast === 'function') {
            showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸ', 'warning');
          }
          return;
        }

        this.input.value = normalized;
        this.selectedDate = parsed;
        this.currentDate = new Date(parsed);
        this.render();

        const event = new Event('change', { bubbles: false });
        this.input.dispatchEvent(event);
      }
      
      render() {
        if (!this.monthElement || !this.yearElement || !this.calendar) return;
        
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        // æ›´æ–°æœˆä»½å¹´ä»½æ˜¾ç¤º
        this.monthElement.textContent = (month + 1) + 'æœˆ';
        this.yearElement.textContent = year;
        
        // æ¸…ç©ºæ—¥å†
        this.calendar.innerHTML = '';
        
        // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        // ç”Ÿæˆæ—¥å†ç½‘æ ¼
        for (let i = 0; i < 42; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          
          // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰æœˆä»½
          if (date.getMonth() !== month) {
            dayElement.classList.add('other-month');
          }
          
          // åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©
          const today = new Date();
          if (date.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
          }
          
          // åˆ¤æ–­æ˜¯å¦æ˜¯é€‰ä¸­æ—¥æœŸ
          if (this.selectedDate && date.toDateString() === this.selectedDate.toDateString()) {
            dayElement.classList.add('selected');
          }
          
          // è·å–å†œå†ä¿¡æ¯
          let lunarText = '';
          try {
            const lunar = lunarCalendar.solar2lunar(date.getFullYear(), date.getMonth() + 1, date.getDate());
            if (lunar) {
              if (lunar.day === 1) {
                // åˆä¸€ï¼Œåªæ˜¾ç¤ºæœˆä»½
                lunarText = lunar.isLeap ? 'é—°' + lunar.monthStr.replace('é—°', '') : lunar.monthStr;
              } else {
                // ä¸æ˜¯åˆä¸€ï¼Œæ˜¾ç¤ºæ—¥
                lunarText = lunar.dayStr;
              }
            }
          } catch (error) {
            console.error('å†œå†è½¬æ¢é”™è¯¯:', error);
          }
          
          dayElement.innerHTML =
            '<div>' + date.getDate() + '</div>' +
            '<div class="lunar-text">' + lunarText + '</div>';
          
          dayElement.addEventListener('click', () => this.selectDate(date));
          
          this.calendar.appendChild(dayElement);
        }
      }
      
      // æ˜¾ç¤ºæœˆä»½é€‰æ‹©å™¨
      showMonthPicker() {
        this.currentView = 'month';
        this.hideAllViews();
        if (this.monthPicker) {
          this.monthPicker.classList.remove('hidden');
          // é«˜äº®å½“å‰æœˆä»½
          const monthOptions = this.monthPicker.querySelectorAll('.month-option');
          monthOptions.forEach((option, index) => {
            option.classList.remove('selected');
            if (index === this.currentDate.getMonth()) {
              option.classList.add('selected');
            }
          });
        }
      }
      
      // æ˜¾ç¤ºå¹´ä»½é€‰æ‹©å™¨
      showYearPicker() {
        this.currentView = 'year';
        this.hideAllViews();
        if (this.yearPicker) {
          this.yearPicker.classList.remove('hidden');
        }
        this.renderYearGrid();
      }
      
      // æ˜¾ç¤ºæ—¥å†è§†å›¾
      showCalendar() {
        this.currentView = 'calendar';
        this.hideAllViews();
        this.render();
      }
      
      // éšè—æ‰€æœ‰è§†å›¾
      hideAllViews() {
        if (this.monthPicker) this.monthPicker.classList.add('hidden');
        if (this.yearPicker) this.yearPicker.classList.add('hidden');
        // æ³¨æ„ï¼šä¸éšè—æ—¥å†è§†å›¾ï¼Œå› ä¸ºå®ƒæ˜¯ä¸»è§†å›¾
      }
      
      // é€‰æ‹©æœˆä»½
      selectMonth(month) {
        this.currentDate.setMonth(month);
        this.showCalendar();
      }
      
      // é€‰æ‹©å¹´ä»½
      selectYear(year) {
        this.currentDate.setFullYear(year);
        this.showCalendar();
      }
      
      // ä¸Šä¸€åå¹´
      previousYearDecade() {
        this.yearDecade -= 10;
        this.renderYearGrid();
      }
      
      // ä¸‹ä¸€åå¹´
      nextYearDecade() {
        this.yearDecade += 10;
        this.renderYearGrid();
      }
      
      // æ¸²æŸ“å¹´ä»½ç½‘æ ¼
      renderYearGrid() {
        if (!this.yearGrid || !this.yearRangeElement) return;
        
        const startYear = this.yearDecade;
        const endYear = this.yearDecade + 9;
        
        // æ›´æ–°å¹´ä»½èŒƒå›´æ˜¾ç¤º
        this.yearRangeElement.textContent = startYear + '-' + endYear;
        
        // æ¸…ç©ºå¹´ä»½ç½‘æ ¼
        this.yearGrid.innerHTML = '';
        
        // ç”Ÿæˆå¹´ä»½æŒ‰é’®
        for (let year = startYear; year <= endYear; year++) {
          const yearBtn = document.createElement('button');
          yearBtn.type = 'button';
          yearBtn.className = 'year-option px-3 py-2 text-sm rounded hover:bg-gray-100';
          yearBtn.textContent = year;
          yearBtn.dataset.year = year;
          
          if (year === this.currentDate.getFullYear()) {
            yearBtn.classList.add('bg-indigo-100', 'text-indigo-600');
          }
          
          // é™åˆ¶å¹´ä»½èŒƒå›´ 1900-2100
          if (year < 1900 || year > 2100) {
            yearBtn.disabled = true;
            yearBtn.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
            yearBtn.addEventListener('click', () => this.selectYear(year));
          }
          
          this.yearGrid.appendChild(yearBtn);
        }
      }     
      goToToday() {
        this.currentDate = new Date();
        this.yearDecade = Math.floor(this.currentDate.getFullYear() / 10) * 10;
        this.showCalendar();
      }
      
      destroy() {
        this.hide();       
        
        if (this.input && this._forceShowHandler) {  // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
          this.input.removeEventListener('click', this._forceShowHandler);
        }
        if (this.input && this._manualInputHandler) {
          this.input.removeEventListener('blur', this._manualInputHandler);
        }
        if (this.input && this._manualKeydownHandler) {
          this.input.removeEventListener('keydown', this._manualKeydownHandler);
        }
        if (this.prevBtn && this._prevHandler) {
          this.prevBtn.removeEventListener('click', this._prevHandler);
        }
        if (this.nextBtn && this._nextHandler) {
          this.nextBtn.removeEventListener('click', this._nextHandler);
        }
        if (this.monthElement && this._showMonthHandler) {
          this.monthElement.removeEventListener('click', this._showMonthHandler);
        }
        if (this.yearElement && this._showYearHandler) {
          this.yearElement.removeEventListener('click', this._showYearHandler);
        }
        if (this.monthPicker && this._monthSelectHandler) {
          this.monthPicker.removeEventListener('click', this._monthSelectHandler);
        }
        if (this.backToCalendarBtn && this._backToCalendarHandler) {
          this.backToCalendarBtn.removeEventListener('click', this._backToCalendarHandler);
        }
        if (this.backToCalendarFromYearBtn && this._backToCalendarFromYearHandler) {
          this.backToCalendarFromYearBtn.removeEventListener('click', this._backToCalendarFromYearHandler);
        }
        if (this.prevYearDecadeBtn && this._prevYearDecadeHandler) {
          this.prevYearDecadeBtn.removeEventListener('click', this._prevYearDecadeHandler);
        }
        if (this.nextYearDecadeBtn && this._nextYearDecadeHandler) {
          this.nextYearDecadeBtn.removeEventListener('click', this._nextYearDecadeHandler);
        }
        if (this.goToTodayBtn && this._goToTodayHandler) {
          this.goToTodayBtn.removeEventListener('click', this._goToTodayHandler);
        }
        if (this._outsideClickHandler) {
          document.removeEventListener('click', this._outsideClickHandler);
        }
      }
    }
    
    // === è‡ªå®šä¹‰ä¸‹æ‹‰èœå•é€»è¾‘ ===
    const TYPE_OPTIONS = [
      "æµåª’ä½“", "è§†é¢‘å¹³å°", "éŸ³ä¹å¹³å°", "äº‘æœåŠ¡", "è½¯ä»¶è®¢é˜…", 
      "åŸŸå", "æœåŠ¡å™¨", "ä¼šå‘˜æœåŠ¡", "å­¦ä¹ å¹³å°", "å¥èº«/è¿åŠ¨", 
      "æ¸¸æˆ", "æ–°é—»/æ‚å¿—", "ç”Ÿæ—¥", "çºªå¿µæ—¥", "å…¶ä»–"
    ];
    
    const CATEGORY_OPTIONS = [
      "ä¸ªäºº", "å®¶åº­", "å·¥ä½œ", "å…¬å¸", "å¨±ä¹", "å­¦ä¹ ", 
      "å¼€å‘", "ç”Ÿäº§åŠ›", "ç¤¾äº¤", "å¥åº·", "è´¢åŠ¡"
    ];

    function initCustomDropdown(inputId, listId, options) {
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;
      list.innerHTML = options.map(opt => 
        '<div class="dropdown-item">' + opt + '</div>'
      ).join('');

      if (!input.dataset.dropdownBound) {
        input.dataset.dropdownBound = 'true';
        const showList = (e) => {
          e.stopPropagation();
          document.querySelectorAll('.custom-dropdown-list').forEach(el => el.classList.remove('show'));
          list.classList.add('show');
        };

        input.addEventListener('focus', showList);
        input.addEventListener('click', showList); // é€‚é…ç§»åŠ¨ç«¯ç‚¹å‡»

        list.addEventListener('click', (e) => {
          e.stopPropagation();
          if (e.target.classList.contains('dropdown-item')) {
            input.value = e.target.textContent;
            input.dispatchEvent(new Event('input'));
            list.classList.remove('show');
          }
        });
      }
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.custom-dropdown-wrapper')) {
        document.querySelectorAll('.custom-dropdown-list').forEach(el => el.classList.remove('show'));
      }
    });

    function setupModalEventListeners() {     
      const calculateExpiryBtn = document.getElementById('calculateExpiryBtn'); // è·å–DOMå…ƒç´ 
      const useLunar = document.getElementById('useLunar');
      const showLunar = document.getElementById('showLunar');
      const startDate = document.getElementById('startDate');
      const expiryDate = document.getElementById('expiryDate');
      const cancelBtn = document.getElementById('cancelBtn');
      
      initCustomDropdown('customType', 'customTypeDropdown', TYPE_OPTIONS); // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰èœå•
      initCustomDropdown('category', 'categoryDropdown', CATEGORY_OPTIONS);    
      
      if (calculateExpiryBtn && !calculateExpiryBtn.dataset.bound) {
        calculateExpiryBtn.dataset.bound = 'true';
        calculateExpiryBtn.addEventListener('click', calculateExpiryDate); // ç»‘å®šäº‹ä»¶
      }
      if (useLunar && !useLunar.dataset.bound) {
        useLunar.dataset.bound = 'true';
        useLunar.addEventListener('change', calculateExpiryDate);
      }
      if (showLunar && !showLunar.dataset.bound) {
        showLunar.dataset.bound = 'true';
        showLunar.addEventListener('change', toggleLunarDisplay);
      }
      if (startDate && !startDate.dataset.bound) {
        startDate.dataset.bound = 'true';
        startDate.addEventListener('change', () => updateLunarDisplay('startDate', 'startDateLunar'));
      }
      if (expiryDate && !expiryDate.dataset.bound) {
        expiryDate.dataset.bound = 'true';
        expiryDate.addEventListener('change', () => updateLunarDisplay('expiryDate', 'expiryDateLunar'));
      }
      if (cancelBtn && !cancelBtn.dataset.bound) {
        cancelBtn.dataset.bound = 'true';
        cancelBtn.addEventListener('click', () => {
          document.getElementById('subscriptionModal').classList.add('hidden');
          document.body.classList.remove('overflow-hidden'); // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        });
      }

      ['startDate', 'periodValue', 'periodUnit'].forEach(id => {
        const element = document.getElementById(id);
        if (element && !element.dataset.bound) {
          element.dataset.bound = 'true';
          element.addEventListener('change', calculateExpiryDate);
        }
      });
      // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
      try {
        if (window.startDatePicker && typeof window.startDatePicker.destroy === 'function') window.startDatePicker.destroy();
        if (window.expiryDatePicker && typeof window.expiryDatePicker.destroy === 'function') window.expiryDatePicker.destroy();
        
        window.startDatePicker = null;
        window.expiryDatePicker = null;
        
        setTimeout(() => {
          window.startDatePicker = new CustomDatePicker(
            'startDate', 'startDatePicker', 'startDateCalendar', 
            'startDateMonth', 'startDateYear', 'startDatePrevMonth', 'startDateNextMonth'
          );
          window.expiryDatePicker = new CustomDatePicker(
            'expiryDate', 'expiryDatePicker', 'expiryDateCalendar', 
            'expiryDateMonth', 'expiryDateYear', 'expiryDatePrevMonth', 'expiryDateNextMonth'
          );
        }, 50);
      } catch (error) {
        console.error('åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨å¤±è´¥:', error);
      }
    }

	// åœ¨ script æ ‡ç­¾é¡¶éƒ¨å®šä¹‰å…¨å±€å˜é‡
  let isEditingLoading = false;
  const debugLog = (...args) => {
    if (window.DEBUG_LOGS === true) console.log(...args);
  };
    // 3. æ–°å¢ä¿®æ”¹ï¼Œ calculateExpiryDate å‡½æ•°ï¼Œæ”¯æŒå†œå†å‘¨æœŸæ¨ç®—     
	function calculateExpiryDate() {
    if (isEditingLoading) return;

	  const startDate = document.getElementById('startDate').value;
	  const periodValue = parseInt(document.getElementById('periodValue').value);
	  const periodUnit = document.getElementById('periodUnit').value;
	  const useLunar = document.getElementById('useLunar').checked;

	  if (!startDate || !periodValue || !periodUnit) {
		return;
	  }

	  if (useLunar) {
		// å†œå†æ¨ç®—
		const start = new Date(startDate);
		const lunar = lunarCalendar.solar2lunar(start.getFullYear(), start.getMonth() + 1, start.getDate());
		let nextLunar = addLunarPeriod(lunar, periodValue, periodUnit);
		const solar = lunar2solar(nextLunar);
		
		// ä½¿ç”¨ä¸å…¬å†ç›¸åŒçš„æ–¹å¼åˆ›å»ºæ—¥æœŸ  
		const expiry = new Date(startDate); // ä»åŸå§‹æ—¥æœŸå¼€å§‹  
		expiry.setFullYear(solar.year);  
		expiry.setMonth(solar.month - 1);  
		expiry.setDate(solar.day);  
		document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
		debugLog('start:', start);
		debugLog('nextLunar:', nextLunar);
		debugLog('expiry:', expiry);
		debugLog('expiryDate:', document.getElementById('expiryDate').value);
		
		debugLog('solar from lunar2solar:', solar);  
		debugLog('solar.year:', solar.year, 'solar.month:', solar.month, 'solar.day:', solar.day);
		debugLog('expiry.getTime():', expiry.getTime());  
		debugLog('expiry.toString():', expiry.toString());
		
		
	  } else {
		// å…¬å†æ¨ç®—
		const start = new Date(startDate);
		const expiry = new Date(start);
		if (periodUnit === 'day') {
		  expiry.setDate(start.getDate() + periodValue);
		} else if (periodUnit === 'month') {
		  expiry.setMonth(start.getMonth() + periodValue);
		} else if (periodUnit === 'year') {
		  expiry.setFullYear(start.getFullYear() + periodValue);
		}
		document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
		debugLog('start:', start);
		debugLog('expiry:', expiry);
		debugLog('expiryDate:', document.getElementById('expiryDate').value);
	  }

	  // æ›´æ–°å†œå†æ˜¾ç¤º
	  updateLunarDisplay('startDate', 'startDateLunar');
	  updateLunarDisplay('expiryDate', 'expiryDateLunar');
	}
    
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('subscriptionModal').classList.add('hidden');
      document.body.classList.remove('overflow-hidden'); // æ¢å¤é¡µé¢æ»šåŠ¨
    });
    
    document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!validateForm()) {
        return;
      }
      
      const id = document.getElementById('subscriptionId').value;
      const reminderUnit = document.getElementById('reminderUnit').value;
      const reminderValue = Number(document.getElementById('reminderValue').value) || 0;
      const reminderHint = document.getElementById('reminderHint');
      if (reminderHint) {
        reminderHint.textContent = reminderUnit === 'hour'
          ? 'å°æ—¶çº§æé†’ï¼šéœ€ä¿è¯ Worker æ¯å°æ—¶æ‰§è¡Œï¼›0 è¡¨ç¤ºä»…åˆ°æœŸæ—¶æé†’'
          : '0 = ä»…åœ¨åˆ°æœŸæ—¶æé†’';
      }

      const subscription = {
        name: document.getElementById('name').value.trim(),
        customType: document.getElementById('customType').value.trim(),
        category: document.getElementById('category').value.trim(),
        subscriptionMode: document.getElementById('subscriptionMode').value, // æ–°å¢ä¿®æ”¹ï¼Œè¡¨å•æäº¤æ—¶å¸¦ä¸Š subscriptionMode å­—æ®µ
        notes: document.getElementById('notes').value.trim() || '',
        currency: document.getElementById('currency').value, // æ–°å¢ä¿®æ”¹ï¼Œè¡¨å•æäº¤æ—¶å¸¦ä¸Š currency å­—æ®µ
        amount: document.getElementById('amount').value ? parseFloat(document.getElementById('amount').value) : null,
        isActive: document.getElementById('isActive').checked,
        autoRenew: document.getElementById('autoRenew').checked,
        startDate: document.getElementById('startDate').value,
        expiryDate: document.getElementById('expiryDate').value,
        periodValue: Number(document.getElementById('periodValue').value),
        periodUnit: document.getElementById('periodUnit').value,
        reminderUnit: reminderUnit,
        reminderValue: reminderValue,
        reminderDays: reminderUnit === 'day' ? reminderValue : 0,
        reminderHours: reminderUnit === 'hour' ? reminderValue : undefined,
        useLunar: document.getElementById('useLunar').checked
      };
      
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalContent = submitButton.innerHTML;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + (id ? 'æ›´æ–°ä¸­...' : 'ä¿å­˜ä¸­...');
      submitButton.disabled = true;
      
      try {
        const url = id ? '/api/subscriptions/' + id : '/api/subscriptions';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(subscription)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…æˆåŠŸ', 'success');
          document.getElementById('subscriptionModal').classList.add('hidden');
          document.body.classList.remove('overflow-hidden'); // æ¢å¤èƒŒæ™¯æ»šåŠ¨
          loadSubscriptions();
        } else {
          showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥:', error);
        showToast((id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'è®¢é˜…å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
      } finally {
        submitButton.innerHTML = originalContent;
        submitButton.disabled = false;
      }
    });
    
	    // æ–°å¢ä¿®æ”¹ï¼Œç¼–è¾‘è®¢é˜…æ—¶å›æ˜¾ useLunar å­—æ®µ
    async function editSubscription(e) {
      const id = e.target.dataset.id || e.target.parentElement.dataset.id;
      
      try {
        const response = await fetch('/api/subscriptions/' + id);
        const subscription = await response.json();
        
        if (subscription) {
          document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®¢é˜…';
          document.getElementById('subscriptionId').value = subscription.id;
          document.getElementById('name').value = subscription.name;
          document.getElementById('subscriptionMode').value = subscription.subscriptionMode || 'cycle'; // é»˜è®¤ä¸º cycle
          document.getElementById('customType').value = subscription.customType || '';
          document.getElementById('category').value = subscription.category || '';
          document.getElementById('notes').value = subscription.notes || '';
          document.getElementById('amount').value = subscription.amount || '';
          document.getElementById('currency').value = subscription.currency || 'CNY'; // é»˜è®¤è®¾ç½®ä¸º CNY
          document.getElementById('isActive').checked = subscription.isActive !== false;
          document.getElementById('autoRenew').checked = subscription.autoRenew !== false;
          document.getElementById('startDate').value = subscription.startDate ? subscription.startDate.split('T')[0] : '';
          document.getElementById('expiryDate').value = subscription.expiryDate ? subscription.expiryDate.split('T')[0] : '';
          document.getElementById('periodValue').value = subscription.periodValue || 1;
          document.getElementById('periodUnit').value = subscription.periodUnit || 'month';
          const reminderUnit = subscription.reminderUnit || (subscription.reminderHours !== undefined ? 'hour' : 'day');
          let reminderValue;
          const reminderHint = document.getElementById('reminderHint');
          if (reminderUnit === 'hour') {
            if (subscription.reminderValue !== undefined && subscription.reminderValue !== null) {
              reminderValue = subscription.reminderValue;
            } else if (subscription.reminderHours !== undefined) {
              reminderValue = subscription.reminderHours;
            } else {
              reminderValue = 0;
            }
          } else {
            if (subscription.reminderValue !== undefined && subscription.reminderValue !== null) {
              reminderValue = subscription.reminderValue;
            } else if (subscription.reminderDays !== undefined) {
              reminderValue = subscription.reminderDays;
            } else {
              reminderValue = 7;
            }
          }
          document.getElementById('reminderUnit').value = reminderUnit;
          document.getElementById('reminderValue').value = reminderValue;
          if (reminderHint) {
            reminderHint.textContent = reminderUnit === 'hour'
              ? 'å°æ—¶çº§æé†’ï¼šéœ€ä¿è¯ Worker æ¯å°æ—¶æ‰§è¡Œï¼›0 è¡¨ç¤ºä»…åˆ°æœŸæ—¶æé†’'
              : '0 = ä»…åœ¨åˆ°æœŸæ—¶æé†’';
          }
          document.getElementById('useLunar').checked = !!subscription.useLunar;
          
          clearFieldErrors();
          loadLunarPreference();
          document.getElementById('subscriptionModal').classList.remove('hidden');
          document.body.classList.add('overflow-hidden'); // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
          
          // é‡è¦ï¼šç¼–è¾‘è®¢é˜…æ—¶ä¹Ÿéœ€è¦é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
          setupModalEventListeners();

          // æ›´æ–°å†œå†æ˜¾ç¤º
          setTimeout(() => {
            updateLunarDisplay('startDate', 'startDateLunar');
            updateLunarDisplay('expiryDate', 'expiryDateLunar');
            // é‡è¦ï¼šå»¶è¿Ÿé‡Šæ”¾åŠ è½½é”ï¼Œç­‰å¾… DatePicker åˆå§‹åŒ–è§¦å‘çš„ change äº‹ä»¶ç»“æŸ
            setTimeout(() => {
                isEditingLoading = false;
            }, 200);
          }, 100);
        }
      } catch (error) {
        console.error('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥:', error);
        showToast('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥', 'error');
        isEditingLoading = false; // å¼‚å¸¸æ—¶ä¹Ÿè¦é‡Šæ”¾é”
      }
    }
    
    async function deleteSubscription(e) {
      const id = e.target.dataset.id || e.target.parentElement.dataset.id;
      
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      const button = e.target.tagName === 'BUTTON' ? e.target : e.target.parentElement;
      const originalContent = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>åˆ é™¤ä¸­...';
      button.disabled = true;
      
      try {
        const response = await fetch('/api/subscriptions/' + id, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('åˆ é™¤æˆåŠŸ', 'success');
          loadSubscriptions();
        } else {
          const error = await response.json();
          showToast('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      } catch (error) {
        console.error('åˆ é™¤è®¢é˜…å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error');
        button.innerHTML = originalContent;
        button.disabled = false;
      }
    }
    
    // å…¨å±€æ—¶åŒºé…ç½®
    let globalTimezone = 'UTC';
    
    // æ£€æµ‹æ—¶åŒºæ›´æ–°
    function checkTimezoneUpdate() {
      const lastUpdate = localStorage.getItem('timezoneUpdated');
      if (lastUpdate) {
        const updateTime = parseInt(lastUpdate);
        const currentTime = Date.now();
        // å¦‚æœæ—¶åŒºæ›´æ–°å‘ç”Ÿåœ¨æœ€è¿‘5ç§’å†…ï¼Œåˆ™åˆ·æ–°é¡µé¢
        if (currentTime - updateTime < 5000) {
          localStorage.removeItem('timezoneUpdated');
          window.location.reload();
        }
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ—¶åŒºæ›´æ–°
    window.addEventListener('load', () => {
      checkTimezoneUpdate();
      loadSubscriptions();
    });
    
    // å®šæœŸæ£€æŸ¥æ—¶åŒºæ›´æ–°ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
    setInterval(checkTimezoneUpdate, 2000);

    // å®æ—¶æ˜¾ç¤ºç³»ç»Ÿæ—¶é—´å’Œæ—¶åŒºï¼ˆå‰ç«¯ç»Ÿä¸€æœ¬åœ°æ—¶åŒºæ˜¾ç¤ºï¼‰
    async function showSystemTime() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        window.DEBUG_LOGS = config.DEBUG_LOGS === true;

        const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        globalTimezone = localTimezone;

        function formatTimezoneDisplay(tz) {
          try {
            const now = new Date();
            const dtf = new Intl.DateTimeFormat('en-US', {
              timeZone: tz,
              hour12: false,
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const parts = dtf.formatToParts(now);
            const get = type => Number(parts.find(x => x.type === type).value);
            const target = Date.UTC(get('year'), get('month') - 1, get('day'), get('hour'), get('minute'), get('second'));
            const utc = now.getTime();
            const offset = Math.round((target - utc) / (1000 * 60 * 60));
            const offsetStr = offset >= 0 ? '+' + offset : offset;
            return `${tz} (UTC${offsetStr})`;
          } catch (error) {
            console.error('æ ¼å¼åŒ–æ—¶åŒºæ˜¾ç¤ºå¤±è´¥:', error);
            return tz;
          }
        }

        function update() {
          const now = new Date();
          const timeStr = now.toLocaleString('zh-CN', {
            timeZone: localTimezone,
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          const tzStr = formatTimezoneDisplay(localTimezone);
          const el = document.getElementById('systemTimeDisplay');
          if (el) {
            el.textContent = `${timeStr}  ${tzStr}`;
          }
          const mobileEl = document.getElementById('mobileTimeDisplay');
          if (mobileEl) {
            mobileEl.textContent = `${timeStr} ${tzStr}`;
          }
        }

        update();
        setInterval(update, 1000);
        loadSubscriptions();
      } catch (e) {
        const el = document.getElementById('systemTimeDisplay');
        if (el) {
          el.textContent = new Date().toLocaleString();
        }
      }
    }
    showSystemTime();
    // --- æ–°å¢ï¼šç§»åŠ¨ç«¯èœå•æ§åˆ¶è„šæœ¬ ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuBtn && mobileMenu) {
      const syncMobileMenuState = () => {
        const icon = mobileMenuBtn.querySelector('i');
        const isHidden = mobileMenu.classList.contains('hidden');
        mobileMenuBtn.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        if (icon) {
          icon.classList.toggle('fa-bars', isHidden);
          icon.classList.toggle('fa-times', !isHidden);
        }
      };

      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        syncMobileMenuState();
      });

      mobileMenu.querySelectorAll('a').forEach(link => {  // ç‚¹å‡»èœå•é¡¹è‡ªåŠ¨å…³é—­
        link.addEventListener('click', () => {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        });
      });

      document.addEventListener('click', (event) => {
        if (mobileMenu.classList.contains('hidden')) return;
        if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      syncMobileMenuState();
    }
  </script>
</body>
</html>