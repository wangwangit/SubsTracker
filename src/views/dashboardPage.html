<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»ªè¡¨ç›˜ - SubsTracker</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  ${themeResources}  <style>
    .stat-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.2s,box-shadow 0.2s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 4px 16px rgba(0,0,0,0.15)}
    .stat-card-header{color:#6b7280;font-size:0.875rem;font-weight:500;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem}
    .stat-card-value{font-size:2rem;font-weight:700;color:#1f2937;margin-bottom:0.25rem}
    .stat-card-subtitle{color:#9ca3af;font-size:0.875rem}
    .stat-card-trend{display:inline-flex;align-items:center;gap:0.25rem;font-size:0.875rem;margin-top:0.5rem;padding:0.25rem 0.5rem;border-radius:6px}
    .stat-card-trend.up{color:#10b981;background:#d1fae5}
    .stat-card-trend.down{color:#ef4444;background:#fee2e2}
    .stat-card-trend.flat{color:#6b7280;background:#f3f4f6}
    .list-item{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-radius:8px;transition:background 0.2s}
    .list-item:hover{background:#f9fafb}
    .list-item:not(:last-child){border-bottom:1px solid #f3f4f6}
    .list-item-content{flex:1}
    .list-item-name{font-weight:600;color:#1f2937;margin-bottom:0.25rem}
    .list-item-meta{display:flex;align-items:center;gap:1rem;font-size:0.875rem;color:#6b7280;flex-wrap:wrap}
    .list-item-amount{font-size:1.125rem;font-weight:700;color:#10b981}
    .list-item-badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:500;background:#e0e7ff;color:#4f46e5}
    .ranking-item{margin-bottom:1rem}
    .ranking-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .ranking-item-name{font-weight:600;color:#1f2937}
    .ranking-item-value{display:flex;align-items:center;gap:0.5rem;font-size:0.875rem}
    .ranking-item-amount{font-weight:700;color:#1f2937}
    .ranking-item-percentage{color:#10b981}
    .ranking-progress{width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
    .ranking-progress-bar{height:100%;border-radius:4px;transition:width 0.6s ease}
    .ranking-progress-bar.color-1{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .ranking-progress-bar.color-2{background:linear-gradient(90deg,#10b981,#059669)}
    .ranking-progress-bar.color-3{background:linear-gradient(90deg,#f59e0b,#d97706)}
    .ranking-progress-bar.color-4{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .ranking-progress-bar.color-5{background:linear-gradient(90deg,#8b5cf6,#7c3aed)}
    .empty-state{text-align:center;padding:3rem 1rem;color:#9ca3af}
    .empty-state-icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
    .empty-state-text{font-size:0.875rem}
    /* === Dashboard æš—é»‘æ¨¡å¼ä¿®å¤ === */
    html.dark .stat-card {
      background: #1f2937; /* æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }
    html.dark .stat-card-header { color: #9ca3af; }
    html.dark .stat-card-value { color: #f3f4f6; } /* ç™½è‰²æ–‡å­— */
    html.dark .stat-card-subtitle { color: #6b7280; } 
    html.dark .stat-card-trend.flat { background: #374151; color: #9ca3af; }
    html.dark .stat-card-trend.up { background: rgba(16, 185, 129, 0.2); }
    html.dark .stat-card-trend.down { background: rgba(239, 68, 68, 0.2); }
    html.dark .list-item:hover { background: #374151; }
    html.dark .list-item:not(:last-child) { border-bottom-color: #374151; }
    html.dark .list-item-name { color: #f3f4f6; } /* åˆ—è¡¨é¡¹åç§°å˜ç™½ */
    html.dark .list-item-meta { color: #9ca3af; }
    html.dark .list-item-badge { background: #3730a3; color: #c7d2fe; }
    html.dark .ranking-item-name { color: #f3f4f6; } /* æ’è¡Œæ¦œåç§°å˜ç™½ */
    html.dark .ranking-item-amount { color: #e5e7eb; } /* é‡‘é¢å˜ç™½ */
    html.dark .ranking-progress { background: #374151; }
    /* ä¿®å¤å³ä¸Šè§’çš„æ ‡ç­¾ */
    html.dark .bg-indigo-100 { background-color: rgba(99, 102, 241, 0.2) !important; color: #a5b4fc !important; }
    html.dark .text-indigo-800 { color: #c7d2fe !important; }
    .loading-skeleton{background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 50%,#f3f4f6 75%);background-size:200% 100%;animation:loading 1.5s infinite;height:100px;border-radius:8px}
    /* æš—é»‘æ¨¡å¼éª¨æ¶å± */
    html.dark .loading-skeleton { background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%); }
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-md relative z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center shrink-0">
          <div class="flex items-center">
            <i class="fas fa-calendar-check text-indigo-600 text-2xl mr-2"></i>
            <span class="font-bold text-xl text-gray-800">è®¢é˜…ç®¡ç†ç³»ç»Ÿ</span>
          </div>
          <span id="systemTimeDisplay" class="ml-4 text-base text-indigo-600 font-normal hidden md:block pt-1"></span>
        </div>
        
        <div class="hidden md:flex items-center space-x-4 ml-auto">
          <a href="/admin/dashboard" class="text-indigo-600 border-b-2 border-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-chart-line mr-1"></i>ä»ªè¡¨ç›˜
          </a>
          <a href="/admin" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-list mr-1"></i>è®¢é˜…åˆ—è¡¨
          </a>
          <a href="/admin/config" class="text-gray-700 hover:text-gray-900 border-b-2 border-transparent hover:border-gray-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-cog mr-1"></i>ç³»ç»Ÿé…ç½®
          </a>
          <a href="/api/logout" class="text-gray-700 hover:text-red-600 border-b-2 border-transparent hover:border-red-300 px-3 py-2 rounded-md text-sm font-medium transition">
            <i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•
          </a>
        </div>

        <div class="flex items-center md:hidden ml-auto">
          <button id="mobile-menu-btn" type="button" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆªèœå•" class="text-gray-600 hover:text-indigo-600 focus:outline-none p-2 rounded-md hover:bg-gray-100 active:bg-gray-200 transition-colors">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-b border-gray-200 w-full">
      <div class="px-4 pt-2 pb-4 space-y-2">
        <div id="mobileTimeDisplay" class="px-3 py-2 text-xs text-indigo-600 text-right border-b border-gray-100 mb-2"></div>
        <a href="/admin/dashboard" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-chart-line w-6 text-center mr-2"></i>ä»ªè¡¨ç›˜
        </a>
        <a href="/admin" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-list w-6 text-center mr-2"></i>è®¢é˜…åˆ—è¡¨
        </a>
        <a href="/admin/config" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 active:bg-indigo-100 transition-colors">
          <i class="fas fa-cog w-6 text-center mr-2"></i>ç³»ç»Ÿé…ç½®
        </a>
        <a href="/api/logout" class="block px-3 py-3 rounded-md text-base font-medium text-gray-700 hover:bg-red-50 hover:text-red-600 active:bg-red-100 transition-colors">
          <i class="fas fa-sign-out-alt w-6 text-center mr-2"></i>é€€å‡ºç™»å½•
        </a>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š ä»ªè¡¨æ¿</h2>
      <p class="text-sm text-gray-500 mt-1">è®¢é˜…è´¹ç”¨å’Œæ´»åŠ¨æ¦‚è§ˆï¼ˆç»Ÿè®¡é‡‘é¢å·²æŠ˜åˆä¸º CNYï¼‰</p>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-history text-indigo-500"></i>
          <h3 class="text-lg font-medium text-gray-900">è‡ªåŠ¨æé†’ä»»åŠ¡çŠ¶æ€</h3>
        </div>
        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">Cron å¯è§‚æµ‹æ€§</span>
      </div>
      <div class="p-6" id="schedulerStatus">
        <div class="loading-skeleton"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" id="statsGrid">
      <div class="loading-skeleton"></div>
      <div class="loading-skeleton"></div>
      <div class="loading-skeleton"></div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-check text-blue-500"></i>
          <h3 class="text-lg font-medium text-gray-900">æœ€è¿‘æ”¯ä»˜</h3>
        </div>
        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">è¿‡å»7å¤©</span>
      </div>
      <div class="p-6" id="recentPayments">
        <div class="loading-skeleton"></div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-clock text-yellow-500"></i>
          <h3 class="text-lg font-medium text-gray-900">å³å°†ç»­è´¹</h3>
        </div>
        <span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">æœªæ¥7å¤©</span>
      </div>
      <div class="p-6" id="upcomingRenewals">
        <div class="loading-skeleton"></div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-stream text-indigo-500"></i>
          <h3 class="text-lg font-medium text-gray-900">è‡ªåŠ¨æé†’ä»»åŠ¡å†å²ï¼ˆæœ€è¿‘10æ¬¡ï¼‰</h3>
        </div>
      </div>
      <div class="p-6" id="schedulerStatusHistory">
        <div class="loading-skeleton"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-chart-bar text-purple-500"></i>
            <h3 class="text-lg font-medium text-gray-900">æŒ‰ç±»å‹æ”¯å‡ºæ’è¡Œ</h3>
          </div>
          <span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">å¹´åº¦ç»Ÿè®¡ (æŠ˜åˆCNY)</span>
        </div>
        <div class="p-6" id="expenseByType">
          <div class="loading-skeleton"></div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-folder text-green-500"></i>
            <h3 class="text-lg font-medium text-gray-900">æŒ‰åˆ†ç±»æ”¯å‡ºç»Ÿè®¡</h3>
          </div>
          <span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">å¹´åº¦ç»Ÿè®¡ (æŠ˜åˆCNY)</span>
        </div>
        <div class="p-6" id="expenseByCategory">
          <div class="loading-skeleton"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å®šä¹‰è´§å¸ç¬¦å·æ˜ å°„
    const currencySymbols = {
      'CNY': 'Â¥', 'USD': '$', 'HKD': 'HK$', 'TWD': 'NT$', 
      'JPY': 'Â¥', 'EUR': 'â‚¬', 'GBP': 'Â£', 'KRW': 'â‚©', 'TRY': 'â‚º'
    };
    function getSymbol(currency) {
      return currencySymbols[currency] || 'Â¥';
    }

    // å‰ç«¯ç»Ÿä¸€æœ¬åœ°æ—¶åŒºæ˜¾ç¤º
    async function showSystemTime() {
      try {
        const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';

        function formatTimezoneDisplay(tz) {
          try {
            const now = new Date();
            const dtf = new Intl.DateTimeFormat('en-US', {
              timeZone: tz,
              hour12: false,
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const parts = dtf.formatToParts(now);
            const get = type => Number(parts.find(x => x.type === type).value);
            const target = Date.UTC(get('year'), get('month') - 1, get('day'), get('hour'), get('minute'), get('second'));
            const utc = now.getTime();
            const offset = Math.round((target - utc) / (1000 * 60 * 60));
            const offsetStr = offset >= 0 ? '+' + offset : offset;
            return `${tz} (UTC${offsetStr})`;
          } catch (error) {
            console.error('æ ¼å¼åŒ–æ—¶åŒºæ˜¾ç¤ºå¤±è´¥:', error);
            return tz;
          }
        }

        function update() {
          const now = new Date();
          const timeStr = now.toLocaleString('zh-CN', {
            timeZone: localTimezone,
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          const tzStr = formatTimezoneDisplay(localTimezone);
          const el = document.getElementById('systemTimeDisplay');
          if (el) {
            el.textContent = `${timeStr}  ${tzStr}`;
          }
          const mobileEl = document.getElementById('mobileTimeDisplay');
          if (mobileEl) {
            mobileEl.textContent = `${timeStr} ${tzStr}`;
          }
        }

        update();
        setInterval(update, 1000);
      } catch (e) {
        console.error(e);
      }
    }

    async function loadDashboardData(){
      try {
        const r=await fetch('/api/dashboard/stats');
        const d=await r.json();
        if(!d.success) throw new Error(d.message||'åŠ è½½å¤±è´¥');
        
        const data=d.data;

        const schedulerStatusEl = document.getElementById('schedulerStatus');
        if (schedulerStatusEl) {
          const status = data.schedulerStatus;
          if (!status) {
            schedulerStatusEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ•</div><div class="empty-state-text">æš‚æ— å®šæ—¶ä»»åŠ¡æ‰§è¡Œè®°å½•ï¼ˆç­‰å¾…ä¸‹ä¸€æ¬¡ Cronï¼‰</div></div>';
          } else {
            const sendResult = status.sendResult || {};
            const runAt = status.lastRunAt ? new Date(status.lastRunAt).toLocaleString('zh-CN') : 'æœªçŸ¥';
            const configuredHours = Array.isArray(status.configuredHours) && status.configuredHours.length > 0
              ? status.configuredHours.join(', ')
              : 'å…¨éƒ¨æ—¶æ®µ';
            const sentBadge = status.sent
              ? '<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">æœ¬æ¬¡æœ‰å‘é€</span>'
              : '<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">æœ¬æ¬¡æœªå‘é€</span>';

            schedulerStatusEl.innerHTML = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="bg-gray-50 rounded-md p-3">
                  <div class="text-gray-500">æœ€è¿‘æ‰§è¡Œæ—¶é—´</div>
                  <div class="text-gray-900 font-medium mt-1">${runAt}</div>
                </div>
                <div class="bg-gray-50 rounded-md p-3">
                  <div class="text-gray-500">çŠ¶æ€</div>
                  <div class="mt-1">${sentBadge}</div>
                </div>
                <div class="bg-gray-50 rounded-md p-3">
                  <div class="text-gray-500">å½“å‰å°æ—¶ / é…ç½®æ—¶æ®µï¼ˆUTCï¼‰</div>
                  <div class="text-gray-900 font-medium mt-1">${status.currentHour || '--'} / ${configuredHours}</div>
                </div>
                <div class="bg-gray-50 rounded-md p-3">
                  <div class="text-gray-500">æ£€æŸ¥ä¸å‘½ä¸­</div>
                  <div class="text-gray-900 font-medium mt-1">æ£€æŸ¥ ${status.checkedSubscriptions || 0} æ¡ï¼Œå‘½ä¸­ ${status.expiringMatched || 0} æ¡</div>
                </div>
                <div class="bg-gray-50 rounded-md p-3 md:col-span-2">
                  <div class="text-gray-500">å‘é€ç»“æœ</div>
                  <div class="text-gray-900 font-medium mt-1">å°è¯• ${sendResult.attempted || 0} ä¸ªæ¸ é“ï¼ŒæˆåŠŸ ${sendResult.successCount || 0}ï¼Œå¤±è´¥ ${sendResult.failedCount || 0}ï¼Œå»é‡è·³è¿‡ ${status.dedupeSkipped || 0}</div>
                  <div class="text-xs text-gray-500 mt-1">${status.reason || 'æš‚æ— è¯¦æƒ…'}</div>
                </div>
              </div>
            `;
          }
        }

        const schedulerHistory = Array.isArray(data.schedulerStatusHistory) ? data.schedulerStatusHistory : [];
        const schedulerHistoryEl = document.getElementById('schedulerStatusHistory');
        if (schedulerHistoryEl) {
          if (schedulerHistory.length === 0) {
            schedulerHistoryEl.innerHTML = '<div class="text-sm text-gray-500">æš‚æ— å†å²è®°å½•</div>';
          } else {
            schedulerHistoryEl.innerHTML = schedulerHistory.slice(0, 10).map(item => {
              const when = item.lastRunAt ? new Date(item.lastRunAt).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
              const sent = item.sent ? 'å·²å‘é€' : 'æœªå‘é€';
              const reason = item.reason || '-';
              return `<div class="py-2 border-b border-gray-100 last:border-b-0 text-sm"><div class="font-medium text-gray-800">${when} Â· ${sent}</div><div class="text-xs text-gray-500 mt-1">${reason}</div></div>`;
            }).join('');
          }
        }

        document.getElementById('statsGrid').innerHTML=`
          <div class="stat-card">
            <div class="stat-card-header">æœˆåº¦æ”¯å‡º (CNY)</div>
            <div class="stat-card-value">Â¥${data.monthlyExpense.amount.toFixed(2)}</div>
            <div class="stat-card-subtitle">æœ¬æœˆæŠ˜åˆæ”¯å‡º</div>
            <div class="stat-card-trend ${data.monthlyExpense.trendDirection}">
              <i class="fas fa-arrow-${data.monthlyExpense.trendDirection==='up'?'up':data.monthlyExpense.trendDirection==='down'?'down':'right'}"></i>
              ${data.monthlyExpense.trend}%
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-card-header">å¹´åº¦æ”¯å‡º (CNY)</div>
            <div class="stat-card-value">Â¥${data.yearlyExpense.amount.toFixed(2)}</div>
            <div class="stat-card-subtitle">æœˆå‡æ”¯å‡º: Â¥${data.yearlyExpense.monthlyAverage.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-card-header">æ´»è·ƒè®¢é˜…</div>
            <div class="stat-card-value">${data.activeSubscriptions.active}</div>
            <div class="stat-card-subtitle">æ€»è®¢é˜…æ•°: ${data.activeSubscriptions.total}</div>
            ${data.activeSubscriptions.expiringSoon>0?`<div class="stat-card-trend down"><i class="fas fa-exclamation-circle"></i>${data.activeSubscriptions.expiringSoon} å³å°†åˆ°æœŸ</div>`:''}
          </div>
        `;
        
        const rp=document.getElementById('recentPayments');
        rp.innerHTML=data.recentPayments.length===0?'<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-text">è¿‡å»7å¤©å†…æ²¡æœ‰æ”¯ä»˜è®°å½•</div></div>':
        data.recentPayments.map(s=>`
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-name">${s.name}</div>
              <div class="list-item-meta">
                <span><i class="fas fa-calendar"></i> ${new Date(s.paymentDate).toLocaleDateString('zh-CN')}</span>
                ${s.customType?`<span class="list-item-badge">${s.customType}</span>`:''}
              </div>
            </div>
            <div class="list-item-amount">${getSymbol(s.currency)}${(s.amount||0).toFixed(2)}</div>
          </div>
        `).join('');
        
        const ur=document.getElementById('upcomingRenewals');
        ur.innerHTML=data.upcomingRenewals.length===0?'<div class="empty-state"><div class="empty-state-icon">âœ…</div><div class="empty-state-text">æœªæ¥7å¤©å†…æ²¡æœ‰å³å°†ç»­è´¹çš„è®¢é˜…</div></div>':
        data.upcomingRenewals.map(s=>`
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-name">${s.name}</div>
              <div class="list-item-meta">
                <span><i class="fas fa-clock"></i> ${new Date(s.renewalDate).toLocaleDateString('zh-CN')}</span>
                <span style="color:#f59e0b;font-weight:600">${s.daysUntilRenewal} å¤©å</span>
                ${s.customType?`<span class="list-item-badge">${s.customType}</span>`:''}
              </div>
            </div>
            <div class="list-item-amount">${getSymbol(s.currency)}${(s.amount||0).toFixed(2)}</div>
          </div>
        `).join('');
        
        const et=document.getElementById('expenseByType');
        et.innerHTML=data.expenseByType.length===0?'<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">æš‚æ— æ”¯å‡ºæ•°æ®</div></div>':
        data.expenseByType.map((item,i)=>`
          <div class="ranking-item">
            <div class="ranking-item-header">
              <div class="ranking-item-name">${item.type}</div>
              <div class="ranking-item-value">
                <span class="ranking-item-amount">Â¥${item.amount.toFixed(2)}</span>
                <span class="ranking-item-percentage">${item.percentage}%</span>
              </div>
            </div>
            <div class="ranking-progress">
              <div class="ranking-progress-bar color-${(i%5)+1}" style="width:${item.percentage}%"></div>
            </div>
          </div>
        `).join('');
        
        const ec=document.getElementById('expenseByCategory');
        ec.innerHTML=data.expenseByCategory.length===0?'<div class="empty-state"><div class="empty-state-icon">ğŸ“‚</div><div class="empty-state-text">æš‚æ— æ”¯å‡ºæ•°æ®</div></div>':
        data.expenseByCategory.map((item,i)=>`
          <div class="ranking-item">
            <div class="ranking-item-header">
              <div class="ranking-item-name">${item.category}</div>
              <div class="ranking-item-value">
                <span class="ranking-item-amount">Â¥${item.amount.toFixed(2)}</span>
                <span class="ranking-item-percentage">${item.percentage}%</span>
              </div>
            </div>
            <div class="ranking-progress">
              <div class="ranking-progress-bar color-${(i%5)+1}" style="width:${item.percentage}%"></div>
            </div>
          </div>
        `).join('');
      } catch(e){
        console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:',e);
        document.getElementById('statsGrid').innerHTML='<div class="empty-state"><div class="empty-state-icon">âŒ</div><div class="empty-state-text">åŠ è½½å¤±è´¥:'+e.message+'</div></div>';
      }
    }
    
    // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤ºå’Œæ•°æ®åŠ è½½
    showSystemTime();
    loadDashboardData();
    setInterval(loadDashboardData, 60000);

    // --- ç§»åŠ¨ç«¯èœå•æ§åˆ¶è„šæœ¬ ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuBtn && mobileMenu) {
      const syncMobileMenuState = () => {
        const icon = mobileMenuBtn.querySelector('i');
        const isHidden = mobileMenu.classList.contains('hidden');
        mobileMenuBtn.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        if (icon) {
          icon.classList.toggle('fa-bars', isHidden);
          icon.classList.toggle('fa-times', !isHidden);
        }
      };

      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        syncMobileMenuState();
      });

      mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        });
      });

      document.addEventListener('click', (event) => {
        if (mobileMenu.classList.contains('hidden')) return;
        if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          syncMobileMenuState();
        }
      });

      syncMobileMenuState();
    }
  </script>
</body>
</html>